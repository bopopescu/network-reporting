{% extends "ad_network_base.html" %}
{% load filters %}

{% block pageTitle %}
  <div class="breadcrumb">
    <a class="linkIcon breadcrumb-back" href="/campaigns/networks/"><span class="ui-icon ui-icon-arrowthick-1-w"></span> Back to Networks</a>
    <h1>Ad Network Revenue Report</h1>
  </div>
{% endblock pageTitle %}

{% block titleBarRight %}
  <span class="titlebar-right">
    <a class="button" id="network-settingsButton" href="#">Edit Revenue Reporting Settings</a>
  </span>
{% endblock titleBarRight %}

{% block preContent %}
  <section id="network-settingsForm" class="hidden">
    <div>
      <form accept-charset="ascii" id="networkForm" class="settingsForm">
        <fieldset id="networkForm-details" class="alt">
          <div id="settings-form-message" class="hidden alert-message block-message warning"></div>
          <div>
            <dl class="formFields" style="margin:0">
              <dt> E-mail: </dt>
              <dd> <input name="email" type="checkbox" {% if settings.email %} checked="true" {% endif %}/> &nbsp;Send me a daily ad network revenue report</dd>
              <dt> Recipients: </dt>
              <dd>
                <textarea name="recipients" rows="3" cols="80">{{settings.recipients}}</textarea>
              </dd>
            </dl>
          </div>
          <div class="form-submit" style="clear:both;">
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-cancel">Cancel</a></span>
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-submit">Save</a></span>
          </div>
        </fieldset>
      </form>
    </div>
  </section>
{% endblock preContent %}

{% block innerContent %}
  <section id="dashboard-apps">
  <span class="buttonset" id="dashboard-sort">
    <input type="radio" name="dashboard-sort-option" value="networks" checked="checked" id="dashboard-sort-network"/>
    <label for="dashboard-sort-network">Sort by Network</label>
    <input type="radio" name="dashboard-sort-option" value="apps" id="dashboard-sort-app"/>
    <label for="dashboard-sort-app">Sort by App</label>
  </span>
  <div class="buttonBank buttonBank-right">
      <select name='exportSelect' id='ad-network-exportSelect' class='selectmenu export-selectMenu'>
          <option value="">Export</option>
          <option value="/ad_network_reports/export/xls">XLS</option>
          <option value="/ad_network_reports/export/csv">CSV</option>
      </select>
  </div>

  {% comment %}
    Make the table sorted by ad network.
  {% endcomment %}
  <div class="tab-section networks active">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Revenue </th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate </th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for network in networks %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr id="{{network.name}}-row">
            <td class="networkData-icon">
              <img src="/images/{{network.name}}-transparent.png"
              alt="{{network.pretty_name}}" width="75" height="25" />
            </td>
            {% if network.state != LoginStates.NOT_SETUP %}
            <td class="network-status dataTable-name">

                {% if network.state != LoginStates.NOT_SETUP %}
                <span class="muted">Last synced: </span>
                {% endif %}
                <a class="show-status" style="cursor:pointer;" id="{{network.name}}-status">Status</a>
                {% if network.state != LoginStates.NOT_SETUP %}
                <div>
                    <a class="show-hide button button-small" id="{{network.name}}" style="width:75px;">Show Apps</a>
                </div>
                {% endif %}
            </td>
            {% endif %}
            {% if network.state != LoginStates.NOT_SETUP %}
              <td class="dataTable-data numeric revenue">--</td>
              {% if network.name != MOBFOX %}
                <td class="dataTable-data numeric attempts">--</td>
              {% else %}
                <td class="dataTable-data numeric"></td>
              {% endif %}
              <td class="dataTable-data numeric impressions">--</td>
              <td class="dataTable-data numeric cpm">--</td>
              {% if network.name != MOBFOX %}
                <td class="dataTable-data numeric fill-rate">--</td>
              {% else %}
                <td class="dataTable-data numeric"></td>
              {% endif %}
              <td class="dataTable-data numeric clicks">--</td>
              <td class="dataTable-data numeric cpc">--</td>
              <td class="dataTable-data numeric ctr">--</td>
            {% else %}
              {% if network.state == LoginStates.NOT_SETUP %}
              <td class="network-status dataTable-name" colspan="7">
                <div class="form-{{network.name}}-enable">
                 <a class="show-status button button-small" id="{{network.name}}-status">Enable Reporting</a>
                </div>
              </td>
              {% endif %}
            {% endif %}
          </tr>
        </tbody>
      </table>
      <div class="{{network.name}}-status hidden">
        <div class="form-{{network.name}}-message hidden alert-message block-message warning"></div>
        <dl class="formFields thin" style="margin:0">
          {% if network.state == LoginStates.ERROR %}
            <dt>Status:</dt>
            <dd>Last synchronization failed.  Check that your credentials are correct.
            If this error persists, please contact support@mopub.com.</dd>
          {% endif %}
          {% if network.apps_without_pub_ids or network.pub_ids_without_data %}
            <dt>Notes:</dt>
            <dd>
            {% if network.apps_without_pub_ids %}
              {% if network.name == IAD %}
                In order to pull revenue data for your apps, MoPub requires that your
                app names in MoPub match your app names in iAd and you assign an
                iTunes URL for each app. Click 'Edit app settings' for each app and
                enter your iTunes URL:
                <br/><br/>
                {% for app in network.apps_without_pub_ids %}<a href="/inventory/app/{{app.key}}">{{app.name}}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
            {% else %}
                In order to pull revenue data for your apps, MoPub requires that you
                assign your ad network ID for each app.  Set up your network ID on
                the <a href="/account/networks/">Ad Network Settings</a> page for the
                following apps:
                <br/><br/>
                {% for app in network.apps_without_pub_ids %}{{app.name}}{% if not forloop.last %}, {% endif %}{% endfor %}
              {% endif %}
            {% else %}
              {% if network.name == IAD %}
                MoPub received a response for the following apps. Make sure these
                apps are properly set up in MoPub to view the reports (the MoPub
                app names exactly match the iAd app names and the iTunes URLs
                are properly entered for the apps).
              {% else %}
                MoPub received a response for the following ad networks IDs.
                Make sure these apps are properly set up in MoPub to view the reports.
              {% endif %}
              <br/><br/>
              {% for id in network.pub_ids_without_data %}{{id}}{% if not forloop.last %}, {% endif %}{% endfor %}
            {% endif %}
            </dd>
          {% endif %}
        </dl>
        <div style="clear:both;">
          <form class="loginCredentials" id="form-{{network.name}}" autocomplete="off">
            <fieldset>
                <h2>{{network.pretty_name}} Credentials{% if network.name == ADMOB or network.name == INMOBI %} <a target="_blank" href="http://help.mopub.com/customer/portal/articles/{% ifequal network.name ADMOB %}274115-admob-revenue-reporting-setup{% else %}274260-inmobi-revenue-reporting-setup{% endifequal %}">(Learn more)</a> {% endif %}</h2>
                <dl class="formFields thin" style="margin:0">
                    {% if network.name == INMOBI %}
                      <dt class="wide"> Access ID: </dt>
                      <dd class="thinner">
                        <input type="text" name="{{network.name}}-username"
                        id="id_username" class="input-text input-text-half-width"
                        value=""> {{network.form.username.errors}}
                      </dd>

                      <dt class="wide"> Secret Key: </dt>
                      <dd class="thinner">
                        <input type="password" name="{{network.name}}-password"
                        id="id_password" class="input-text input-text-half-width"
                        value="">  {{network.form.password.errors}}
                      </dd>

                    {% else %}
                        {% if network.name == MOBFOX %}
                          {% if network.state == LoginStates.NOT_SETUP %}
                            Click 'update' to turn on MobFox revenue reporting.
                          {% else %}
                            MobFox revenue reporting is turned on.
                          {% endif %}
                        {% else %}
                          <dt class="wide"> Username: </dt>
                          <dd class="thinner"> <input type="text" name="{{network.name}}-username" id="id_username" class="input-text input-text-half-width" value="{{network.form.initial.username}}"> {{network.form.username.errors}}</dd>

                          <dt class="wide">{% ifequal network.name ADMOB %} API {% endifequal %}Password: </dt>
                          <dd class="thinner"> <input type="password" name="{{network.name}}-password"  id="id_password" class="input-text input-text-half-width" value="{{network.form.initial.password}}">
                          {{network.form.password.errors}}
                          </dd>
                        {% endif %}
                    {% endif %}


                    {% if network.name == ADMOB %}
                      <dt class="wide"> API Key: </dt>
                      <dd class="thinner"> <input type="text" name="admob-client_key"
                      id="id_admob-client_key" class="input-text
                      input-text-half-width" value="{{network.form.initial.client_key}}"></dd>
                    {% endif %}

                </dl>
            </fieldset>
          </form>
        </div>
      </div>
      {% if network.state != LoginStates.NOT_SETUP %}
      <div class="appData-details hidden {{network.name}}-row" style="margin: -10px 0 0 86px">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody id="app-on-{{network.name}}">
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  {% endfor %}
  </div>

  {% comment %}
    Make the table sorted by app name. This table is hidden to start.
  {% endcomment %}
  <div class="tab-section apps">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Revenue </th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate</th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for app in apps %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr class="app-row" id="{{app.key_}}-row">
            <td class="appData-icon"><a href="/inventory/app/{{app.key_}}"><img src="{% if app.icon_url %}{{app.icon_url}}{% else %}/placeholders/image.gif{% endif %}" alt="Icon" width="45" height="45" /></a></td> <td class="dataTable-name">
                <a href="/inventory/app/{{app.key_}}">{{app.name}}</a>
                <span class="muted unbold">({{app.app_type_text}})</span>
                <img id="{{app.identifier}}-img" class="loading-img" style="display:none;" src="../images/icons-custom/spinner-12.gif"></img>
            </td>
            <td class="dataTable-data numeric revenue">--</td>
            <td class="dataTable-data numeric attempts">--</td>
            <td class="dataTable-data numeric impressions">--</td>
            <td class="dataTable-data numeric cpm">--</td>
            <td class="dataTable-data numeric fill-rate">--</td>
            <td class="dataTable-data numeric clicks">--</td>
            <td class="dataTable-data numeric cpc">--</td>
            <td class="dataTable-data numeric ctr">--</td>
          </tr>
        </tbody>
      </table>
      <div class="appData-details">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody id="{{app.key_}}-on-networks">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
  </section>
{% endblock innerContent %}

{% block extraScripts %}
  {{ block.super }}
  <script type="text/html" id="app-on-network-row-template">
    {% include "partials/app_on_network.html" %}
  </script>
  {% include_script "models/ad_network_reports" %}
  {% include_script "views/ad_network_reports" %}
  {% include_script "controllers/ad_network_reports" %}
  <script>
    $(function () {
        var account_key = '{{ account_key }}';
        AdNetworkReportsController.initializeCredentialsPage(account_key);

        AdNetworkReportsController.initializeAdReportsIndex({
        networks_data: [
        {% for network in networks %}
          {
            network: '{{ network.name }}',
            models: [
              {% for key in network.pub_ids %}
                {
                  id: '{{ key }}',
                  network: '{{ network.name }}'},
                {% endfor %}
                ]
          },
        {% endfor %} ],
        apps_data: [
          {% for app in apps %}
            {
              id: '{{ app.key_ }}',
            },
          {% endfor %} ],
        ajax_query_string: 's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}'
      });
    });
  </script>
{% endblock extraScripts %}
