{% extends "networks_base.html" %}
{% load filters %}

{% block pageTitle %}
  <div class="breadcrumb">
    <h1>Networks</h1>
  </div>
{% endblock pageTitle %}

{% block titleBarRight %}
  <span class="titlebar-right">
    <a class="button" id="network-settingsButton" href="#">Edit ad network settings</a>
  </span>
{% endblock titleBarRight %}

{% block preContent %}
  <section id="network-settingsForm" class="hidden">
    <div>
      <form accept-charset="ascii" id="networkForm" class="settingsForm">
        <fieldset id="networkForm-details" class="alt">
          <div id="settings-form-message" class="hidden alert-message block-message warning"></div>
          <div>
            <dl class="formFields" style="margin:0">
              <dt> E-mail: </dt>
              <dd> <input name="email" type="checkbox" {% if settings.email %} checked="true" {% endif %}/> &nbsp;Send me a daily ad network revenue report</dd>
              <dt> Recipients: </dt>
              <dd>
                <textarea name="recipients" rows="3" cols="80">{{settings.recipients}}</textarea>
              </dd>
            </dl>
          </div>
          <div class="form-submit" style="clear:both;">
            <span class="hidden" id="networkSettingsForm-loading"><img src="/images/loading2.gif"/></span>
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-cancel">Cancel</a></span>
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-submit">Save</a></span>
          </div>
        </fieldset>
      </form>
    </div>
  </section>
{% endblock preContent %}

{% if not networks %}
  {% block graph %}
    <section id="graph">
      <div class="alert-message block-message">
        MoPub can can mediate the ad networks where you have an account. ...more help text
      </div>
    </section>
  {% endblock graph %}
{% endif %}

{% block innerContent %}
  <section id="dashboard-apps">
    {% if reporting %}
      <span class="buttonset">
        <input id="show-both" type="radio" name="show-data" value="both" checked="true"/>
        <label for="show-both" title="Show network stats in green alongside MoPub stats in black.">Show Both</label>
        <input id="show-network" type="radio" name="show-data" value="network"/>
        <label for="show-network" title="Show only network stats.">Show Network Data</label>
        <input id="show-mopub" type="radio" name="show-data" value="mopub"/>
        <label for="show-mopub" title="Show only MoPub stats.">Show MoPub Data</label>
      </span>
    {% endif %}

    {% comment %}
      Make a table for ad networks that are active
    {% endcomment %}
    <div class="tab-section networks">
      <div class="appData-columnHeaders">
        <table class="dataTable" width=100%>
          <thead>
            <th class="networkData-icon" style="width:75px"></th>
            <th class="dataTable-name"> Name </th>
            <th class="dataTable-name"> eCPM </th>
            <th class="dataTable-name"> Revenue </th>
            <th class="dataTable-name"> Attempts </th>
            <th class="dataTable-name"> Impressions </th>
            <th class="dataTable-name"> Clicks </th>
          </thead>
        </table>
      </div>
      {% for network in networks %}
        <div class="{% cycle 'appData' 'appData appData-alt' %}">
          <table class="dataTable appData-main">
            <tbody>
              <tr id="{{network.name}}-row">
                <td class="networkData-icon">
                  <img src="/images/{{network.name}}-transparent.png" alt="{{network.pretty_name}}" width="75" height="25" />
                </td>
                <td class="dataTable-name">
                  {{network.pretty_name}}
                  <div>Targeting: </div>
                </td>
                <td class="dataTable-data numeric">
                  {% if network.reporting %}
                    <div class="cpm network-data">--</div>
                  {% endif %}
                  <div class="mopub-cpm mopub-data">{{network.mopub_stats.get_cpm|currency}}</div>
                </td>
                <td class="dataTable-data numeric">
                  {% if network.reporting %}
                    <div class="revenue network-data">--</div>
                  {% endif %}
                </td>
                {% if network.name != MOBFOX %}
                  <td class="dataTable-data numeric">
                    {% if network.reporting %}
                      <div class="attempts network-data">--</div>
                    {% endif %}
                    <div class="mopub-attempts mopub-data">{{network.mopub_stats.request_count|withsep}}</div>
                  </td>
                {% else %}
                  <td class="dataTable-data numeric"></td>
                {% endif %}
                <td class="dataTable-data numeric">
                  {% if network.reporting %}
                    <div class="impressions network-data">--</div>
                  {% endif %}
                  <div class="mopub-impressions mopub-data">
                    {{network.mopub_stats.impression_count|withsep}} ({{network.mopub_stats.fill_rate|percentage}})
                  </div>
                </td>
                <td class="dataTable-data numeric">
                  {% if network.reporting %}
                    <div class="clicks network-data">--</div>
                  {% endif %}
                  <div class="mopub-clicks mopub-data">
                    {{network.mopub_stats.click_count|withsep}} ({{network.mopub_stats.ctr|percentage}})
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
  </section>

  {% comment %}
    Make a table for the main ad networks that are not setup
  {% endcomment %}
  <section>
    <h2 style="padding-top:25px;">Set Up Ad Networks</h2>
    {% for network in networks_to_setup %}
      <div class="{% cycle 'appData' 'appData appData-alt' %}">
        <table class="dataTable appData-main">
          <tbody>
            <tr id="{{network.name}}-row">
              <td class="networkData-icon">
                <img src="/images/{{network.name}}-transparent.png" alt="{{network.pretty_name}}" width="75" height="25" />
              </td>
              <td>
                <a class="show-status button button-small" href="{% url edit_network network=network.name %}">Set up {{network.pretty_name}}</a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endfor %}
  </section>

  <section>
    <select id='network-editSelect' class='selectmenu'>
      <option value="">Additional Networks</option>
      {% for network in additional_networks %}
        <option value="{% url edit_network network=network.name %}">{{network.pretty_name}}</option>
      {% endfor %}
    </select>
  </section>

{% endblock innerContent %}

{% block extraScripts %}
  {{ block.super }}
  <script type="text/html" id="app-on-network-row-template">
    {% include "partials/app_on_network.html" %}
  </script>
  <script type="text/javascript" src="/js/models/ad_network_reports.js?v=3"></script>
  <script type="text/javascript" src="/js/views/ad_network_reports.js?v=3"></script>
  <script type="text/javascript" src="/js/controllers/networks.js?v=0"></script>
  <script type="text/javascript" src="/js/controllers/ad_network_reports.js?v=0"></script>
  <script>
    $(function () {
        account_key = '{{ account_key }}';

        AdNetworkReportsController.initializeAdReportsIndex({
        networks_data: [{% for network in reporting_networks %} {
           network: '{{ network.name }}',
           models: []},
        {% endfor %}],
        apps_data: [],
        ajax_query_string: 's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}'});

        $('#show-both').click(function() {
            $('.mopub-data').show();
            $('.network-data').show();
        });

        $('#show-network').click(function() {
            $('.mopub-data').hide();
            $('.network-data').show();
        });

        $('#show-mopub').click(function() {
            $('.mopub-data').show();
            $('.network-data').hide();
        });


        $('.show-adunits').click(function() {
            var key = $(this).attr('id');
            var rows = $('.' + key + '-row');
            if (rows.is(':hidden')) {
              rows.show();
              $(this).html("Hide Sites");
            } else {
              rows.hide()
              $(this).html("Show Sites");
            }
        });

        $('#network-editSelect').change(function() {
            if ($(this).val()) {
                window.location = $(this).val();
            }
            $(this).selectmenu('index', 0);
        });

        $('#network-editSelect').find('li').first().hide();
    });
  </script>
{% endblock extraScripts %}
