<html>
	<head>
		<title>Javascript Documentation</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Javascript Documentation</h1></td><td></td></tr><tr class="filename"><td><h2 id="server/public/js/models.js"><a href="#">models</a></h2></td><td>server/public/js/models.js</td></tr><tr class="code">
<td class="docs">
<h1>models.js</h1>

<p>Backbone models
 </p>
</td>
<td class="code">
<pre><code>(<span class="keyword">function</span>($, <span class="class">Backbone</span>, <span class="variable">_</span>) {</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>Campaigns</h2>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">Campaign</span> = <span class="class">Backbone</span>.<span class="class">Model</span>.<span class="variable">extend</span>({
        <span class="variable">defaults</span>: {
            <span class="variable">name</span>: <span class="string">''</span>,
            <span class="variable">budget</span>: <span class="number float">0.0</span>,
            <span class="variable">budget_type</span>: <span class="string">''</span>,
            <span class="variable">start_datetime</span>: <span class="keyword">new</span> <span class="class">Date</span>(),
            <span class="variable">end_datetime</span>: <span class="keyword">null</span>,
            <span class="variable">active</span>: <span class="variable">false</span>
        }
    });

    <span class="keyword">var</span> <span class="class">GuaranteedCampaign</span> = <span class="class">Campaign</span>.<span class="variable">extend</span>({

    });

    <span class="keyword">var</span> <span class="class">PromoCampaign</span> = <span class="class">Campaign</span>.<span class="variable">extend</span>({

    });

    <span class="keyword">var</span> <span class="class">NetworkCampaign</span> = <span class="class">Campaign</span>.<span class="variable">extend</span>({

    });

    <span class="keyword">var</span> <span class="class">Targeting</span> = <span class="class">Backbone</span>.<span class="class">Model</span>.<span class="variable">extend</span>({
        <span class="comment">// for future use?</span>
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>AdGroups</h2>
</td>
<td class="code">

</td>
</tr>
<tr class="code">
<td class="docs">
<p>Helper functions for stats
     </p>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">calculate_ctr</span> (<span class="variable">impression_count</span>, <span class="variable">click_count</span>) {
        <span class="keyword">if</span>(<span class="variable">impression_count</span> === <span class="keyword">null</span> || <span class="variable">click_count</span> === <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="keyword">return</span> (<span class="variable">impression_count</span> === <span class="number integer">0</span>) ? <span class="number integer">0</span> : <span class="variable">click_count</span> / <span class="variable">impression_count</span>;
    }

    <span class="keyword">function</span> <span class="variable">calculate_fill_rate</span> (<span class="variable">request_count</span>, <span class="variable">impression_count</span>) {
        <span class="keyword">if</span>(<span class="variable">request_count</span> === <span class="keyword">null</span> || <span class="variable">impression_count</span> === <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="keyword">return</span> (<span class="variable">request_count</span> === <span class="number integer">0</span>) ? <span class="number integer">0</span> : <span class="variable">impression_count</span> / <span class="variable">request_count</span>;
    }

    <span class="keyword">function</span> <span class="variable">format_stat</span> (<span class="variable">stat</span>, <span class="variable">value</span>) {
        <span class="keyword">if</span>(<span class="variable">value</span> === <span class="keyword">null</span>) <span class="keyword">return</span> <span class="string">'--'</span>;
        <span class="keyword">switch</span>(<span class="variable">stat</span>) {
            <span class="keyword">case</span> <span class="string">'click_count'</span>:
            <span class="keyword">case</span> <span class="string">'conversion_count'</span>:
            <span class="keyword">case</span> <span class="string">'goal'</span>:
            <span class="keyword">case</span> <span class="string">'impression_count'</span>:
            <span class="keyword">case</span> <span class="string">'request_count'</span>:
                <span class="keyword">return</span> <span class="variable">mopub</span>.<span class="class">Utils</span>.<span class="variable">formatNumberWithCommas</span>(<span class="variable">value</span>);
            <span class="keyword">case</span> <span class="string">'cpm'</span>:
            <span class="keyword">case</span> <span class="string">'revenue'</span>:
                <span class="keyword">return</span> <span class="string">'$'</span> + <span class="variable">mopub</span>.<span class="class">Utils</span>.<span class="variable">formatNumberWithCommas</span>(<span class="variable">value</span>.<span class="variable">toFixed</span>(<span class="number integer">2</span>));
            <span class="keyword">case</span> <span class="string">'conv_rate'</span>:
            <span class="keyword">case</span> <span class="string">'ctr'</span>:
            <span class="keyword">case</span> <span class="string">'fill_rate'</span>:
                <span class="keyword">return</span> <span class="variable">mopub</span>.<span class="class">Utils</span>.<span class="variable">formatNumberAsPercentage</span>(<span class="variable">value</span>);
            <span class="keyword">case</span> <span class="string">'status'</span>:
                <span class="keyword">return</span> <span class="variable">value</span>;
            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="string">'Unsupported stat &quot;'</span> + <span class="variable">stat</span> + <span class="string">'&quot;.'</span>;
        }
    }</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>AdGroup model</h2>

<p>This will most likely need to be refactored soon when we change how
AdGroups work on the backend.
     </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">AdGroup</span> = <span class="class">Backbone</span>.<span class="class">Model</span>.<span class="variable">extend</span>({
        <span class="variable">get_stat</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">if</span>(!<span class="this">this</span>.<span class="variable">has</span>(<span class="variable">stat</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">get</span>(<span class="variable">stat</span>);
        },

        <span class="variable">get_formatted_stat</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">return</span> <span class="variable">format_stat</span>(<span class="variable">stat</span>, <span class="this">this</span>.<span class="variable">get_stat</span>(<span class="variable">stat</span>));
        },

        <span class="variable">get_stat_for_day</span>: <span class="keyword">function</span>(<span class="variable">stat</span>, <span class="variable">day</span>) {
            <span class="keyword">if</span>(!<span class="this">this</span>.<span class="variable">has</span>(<span class="variable">daily_stats</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="keyword">var</span> <span class="variable">daily_stats</span> = <span class="this">this</span>.<span class="variable">get</span>(<span class="variable">daily_stats</span>);
            <span class="keyword">if</span>(<span class="variable">day</span> &<span class="variable">gt</span>;= <span class="variable">daily_stats</span>.<span class="variable">length</span>) <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="keyword">var</span> <span class="variable">day_stats</span> = <span class="variable">daily_stats</span>[<span class="variable">day</span>];
            <span class="keyword">if</span>(!<span class="variable">stat</span> <span class="keyword">in</span> <span class="variable">day_stats</span>) <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="keyword">return</span> <span class="variable">day_stats</span>[<span class="variable">stat</span>];
        },

        <span class="variable">url</span>: <span class="keyword">function</span>() {
            <span class="keyword">return</span> <span class="string">'/api/adgroup/'</span> + <span class="this">this</span>.<span class="variable">id</span>;
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>Adgroup Collection</h2>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">AdGroups</span> = <span class="class">Backbone</span>.<span class="class">Collection</span>.<span class="variable">extend</span>({
        <span class="variable">model</span>: <span class="class">AdGroup</span>,

        <span class="variable">get_stat_sum</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">reduce</span>(<span class="keyword">function</span>(<span class="variable">memo</span>, <span class="variable">adgroup</span>) {
                <span class="keyword">if</span>(<span class="variable">memo</span> === <span class="keyword">null</span> || !<span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="variable">stat</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;
                <span class="keyword">return</span> <span class="variable">memo</span> + <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="variable">stat</span>);
            }, <span class="number integer">0</span>);
        },

        <span class="variable">get_stat</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">switch</span>(<span class="variable">stat</span>) {
                <span class="keyword">case</span> <span class="string">'ctr'</span>:
                    <span class="keyword">return</span> <span class="variable">calculate_ctr</span>(<span class="this">this</span>.<span class="variable">get_stat</span>(<span class="string">'impression_count'</span>), <span class="this">this</span>.<span class="variable">get_stat</span>(<span class="string">'click_count'</span>));
                <span class="keyword">case</span> <span class="string">'fill_rate'</span>:
                    <span class="keyword">return</span> <span class="variable">calculate_fill_rate</span>(<span class="this">this</span>.<span class="variable">get_stat</span>(<span class="string">'request_count'</span>), <span class="this">this</span>.<span class="variable">get_stat</span>(<span class="string">'impression_count'</span>));
                <span class="keyword">case</span> <span class="string">'click_count'</span>:
                <span class="keyword">case</span> <span class="string">'conversion_count'</span>:
                <span class="keyword">case</span> <span class="string">'impression_count'</span>:
                <span class="keyword">case</span> <span class="string">'request_count'</span>:
                <span class="keyword">case</span> <span class="string">'revenue'</span>:
                    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">get_stat_sum</span>(<span class="variable">stat</span>);
                <span class="keyword">default</span>:
                    <span class="keyword">throw</span> <span class="string">'Unsupported stat &quot;'</span> + <span class="variable">stat</span> + <span class="string">'&quot;.'</span>;
            }
        },

        <span class="variable">get_formatted_stat</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">return</span> <span class="variable">format_stat</span>(<span class="variable">stat</span>, <span class="this">this</span>.<span class="variable">get_stat</span>(<span class="variable">stat</span>));
        },

        <span class="variable">get_stat_sum_for_day</span>: <span class="keyword">function</span>(<span class="variable">stat</span>, <span class="variable">day</span>) {
            <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">reduce</span>(<span class="keyword">function</span>(<span class="variable">memo</span>, <span class="variable">adgroup</span>) {
                <span class="keyword">if</span>(<span class="variable">memo</span> === <span class="keyword">null</span> ||
                   !<span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="string">'daily_stats'</span>) ||
                   <span class="variable">day</span> &<span class="variable">gt</span>;= <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>).<span class="variable">length</span> ||
                   !(<span class="variable">stat</span> <span class="keyword">in</span> <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>)[<span class="variable">day</span>]))
                    <span class="keyword">return</span> <span class="keyword">null</span>;
                <span class="keyword">return</span> <span class="variable">memo</span> + <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>)[<span class="variable">day</span>][<span class="variable">stat</span>];
            }, <span class="number integer">0</span>);
        },

        <span class="variable">get_stat_for_day</span>: <span class="keyword">function</span>(<span class="variable">stat</span>, <span class="variable">day</span>) {
            <span class="keyword">switch</span>(<span class="variable">stat</span>) {
                <span class="keyword">case</span> <span class="string">'ctr'</span>:
                    <span class="keyword">return</span> <span class="variable">calculate_ctr</span>(<span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="string">'impression_count'</span>, <span class="variable">day</span>), <span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="string">'click_count'</span>, <span class="variable">day</span>));
                <span class="keyword">case</span> <span class="string">'fill_rate'</span>:
                    <span class="keyword">return</span> <span class="variable">calculate_fill_rate</span>(<span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="string">'request_count'</span>, <span class="variable">day</span>), <span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="string">'impression_count'</span>, <span class="variable">day</span>));
                <span class="keyword">case</span> <span class="string">'click_count'</span>:
                <span class="keyword">case</span> <span class="string">'conversion_count'</span>:
                <span class="keyword">case</span> <span class="string">'impression_count'</span>:
                <span class="keyword">case</span> <span class="string">'request_count'</span>:
                <span class="keyword">case</span> <span class="string">'revenue'</span>:
                    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">get_stat_sum_for_day</span>(<span class="variable">stat</span>, <span class="variable">day</span>);
                <span class="keyword">default</span>:
                    <span class="keyword">throw</span> <span class="string">'Unsupported stat &quot;'</span> + <span class="variable">stat</span> + <span class="string">'&quot;.'</span>;
            }
        },

        <span class="variable">get_formatted_stat_for_day</span>: <span class="keyword">function</span>(<span class="variable">stat</span>, <span class="variable">day</span>) {
            <span class="keyword">return</span> <span class="variable">format_stat</span>(<span class="variable">stat</span>, <span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="variable">stat</span>, <span class="variable">day</span>));
        },

        <span class="variable">get_total_daily_stats</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">var</span> <span class="variable">total_daily_stats</span> = [];
            <span class="keyword">for</span>(<span class="keyword">var</span> <span class="variable">day</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">at</span>(<span class="number integer">0</span>).<span class="variable">get</span>(<span class="string">'daily_stats'</span>)) {
                <span class="variable">total_daily_stats</span>.<span class="variable">push</span>(<span class="this">this</span>.<span class="variable">get_stat_for_day</span>(<span class="variable">stat</span>, <span class="variable">day</span>));
            }
            <span class="keyword">return</span> <span class="variable">total_daily_stats</span>;
        },

        <span class="variable">get_chart_data</span>: <span class="keyword">function</span>(<span class="variable">stat</span>) {
            <span class="keyword">var</span> <span class="variable">adgroups</span> = <span class="this">this</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">adgroup</span>) { <span class="keyword">return</span> <span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="variable">stat</span>) &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="string">'daily_stats'</span>); });
            <span class="keyword">if</span>(<span class="variable">adgroups</span>.<span class="variable">length</span> == <span class="number integer">0</span>) {
                <span class="keyword">return</span> [];
            }
            <span class="keyword">var</span> <span class="variable">sorted_adgroups</span> = <span class="variable">_</span>.<span class="variable">sortBy</span>(<span class="variable">adgroups</span>, <span class="keyword">function</span>(<span class="variable">adgroup</span>) {
                <span class="comment">// dash because we're sorting in reverse order</span>
                <span class="keyword">return</span> -<span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'impression_count'</span>);
            });
            <span class="keyword">var</span> <span class="variable">top_three_adgroups</span> = <span class="variable">sorted_adgroups</span>.<span class="variable">splice</span>(<span class="number integer">0</span>, <span class="number integer">3</span>);
            <span class="keyword">var</span> <span class="variable">other_adgroups</span> = <span class="keyword">new</span> <span class="class">AdGroups</span>(<span class="variable">sorted_adgroups</span>);
            <span class="keyword">var</span> <span class="variable">chart_data</span> = <span class="variable">top_three_adgroups</span>.<span class="variable">map</span>(<span class="keyword">function</span>(<span class="variable">adgroup</span>) {
                <span class="keyword">var</span> <span class="variable">adgroup_data</span> = {};
                <span class="variable">adgroup_data</span>[<span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'name'</span>)] = <span class="variable">_</span>.<span class="variable">map</span>(<span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>), <span class="keyword">function</span>(<span class="variable">day</span>) {
                    <span class="keyword">return</span> <span class="variable">day</span>[<span class="variable">stat</span>];
                });
                <span class="keyword">return</span> <span class="variable">adgroup_data</span>;
            });
            <span class="keyword">if</span>(<span class="variable">other_adgroups</span>.<span class="variable">size</span>()) {
                <span class="variable">chart_data</span>.<span class="variable">push</span>({ <span class="string">'Others'</span>: <span class="variable">other_adgroups</span>.<span class="variable">get_total_daily_stats</span>(<span class="variable">stat</span>) });
            }
            <span class="keyword">if</span>(<span class="variable">stat</span> == <span class="string">'ctr'</span>) {
                <span class="variable">chart_data</span>.<span class="variable">push</span>({ <span class="string">'MoPub Optimized'</span>: <span class="this">this</span>.<span class="variable">get_total_daily_stats</span>(<span class="string">'ctr'</span>) });
            }
            <span class="keyword">return</span> <span class="variable">chart_data</span>;
        },

        <span class="variable">get_days</span>: <span class="keyword">function</span>() {
            <span class="comment">// TODO: make this less hacky</span>
            <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">reduce</span>(<span class="keyword">function</span>(<span class="variable">memo</span>, <span class="variable">adgroup</span>) {
                <span class="keyword">return</span> (<span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="string">'daily_stats'</span>) &<span class="variable">amp</span>;&<span class="variable">amp</span>;
                        <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>).<span class="variable">length</span> &<span class="variable">gt</span>; <span class="variable">memo</span>) ? <span class="variable">adgroup</span>.<span class="variable">get</span>(<span class="string">'daily_stats'</span>).<span class="variable">length</span> : <span class="variable">memo</span>;
            }, <span class="number integer">0</span>);
        },

        <span class="variable">isFullyLoaded</span>: <span class="keyword">function</span>() {
            <span class="comment">// TODO: make this less hacky</span>
            <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">reduce</span>(<span class="keyword">function</span>(<span class="variable">memo</span>, <span class="variable">adgroup</span>) { <span class="keyword">return</span> <span class="variable">memo</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">adgroup</span>.<span class="variable">has</span>(<span class="string">'impression_count'</span>) }, <span class="variable">true</span>);
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>AdUnit</h2>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">AdUnit</span> = <span class="class">Backbone</span>.<span class="class">Model</span>.<span class="variable">extend</span>({
        <span class="comment">// If we don't set defaults, the templates will explode</span>
        <span class="variable">defaults</span> : {
            <span class="variable">active</span>: <span class="variable">false</span>,
            <span class="variable">attempts</span>: <span class="number integer">0</span>,
            <span class="variable">clicks</span>: <span class="number integer">0</span>,
            <span class="variable">ctr</span>: <span class="number integer">0</span>,
            <span class="variable">ecpm</span>: <span class="number integer">0</span>,
            <span class="variable">fill_rate</span>: <span class="number integer">0</span>,
            <span class="variable">impressions</span>: <span class="number integer">0</span>,
            <span class="variable">name</span>: <span class="string">''</span>,
            <span class="variable">price_floor</span>: <span class="number integer">0</span>,
            <span class="variable">requests</span>: <span class="number integer">0</span>,
            <span class="variable">revenue</span>: <span class="number integer">0</span>,
            <span class="variable">stats_endpoint</span>: <span class="string">'all'</span>
        },
        <span class="variable">url</span>: <span class="keyword">function</span>() {
            <span class="comment">// window.location.search.substring(1) is used to preserve date ranges from the url</span>
            <span class="comment">// this makes the fetching work with the datepicker.</span>
            <span class="keyword">var</span> <span class="variable">stats_endpoint</span> = <span class="this">this</span>.<span class="variable">get</span>(<span class="string">'stats_endpoint'</span>);
            <span class="keyword">return</span> <span class="string">'/api/app/'</span>
                + <span class="this">this</span>.<span class="variable">app_id</span>
                + <span class="string">'/adunits/'</span>
                + <span class="this">this</span>.<span class="variable">id</span>
                + <span class="string">'?'</span>
                + <span class="variable">window</span>.<span class="variable">location</span>.<span class="variable">search</span>.<span class="variable">substring</span>(<span class="number integer">1</span>)
                + <span class="string">'&amp;endpoint='</span>
                + <span class="variable">stats_endpoint</span>;
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>AdUnitCollection</h2>

<p>Should collections be named 'collection' or should we pluralize their
model name?
     </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">AdUnitCollection</span> = <span class="class">Backbone</span>.<span class="class">Collection</span>.<span class="variable">extend</span>({
        <span class="variable">model</span>: <span class="class">AdUnit</span>,
        <span class="variable">url</span>: <span class="keyword">function</span>() {
            <span class="comment">// window.location.search.substring(1) is used to preserve date ranges from the url</span>
            <span class="comment">// this makes the fetching work with the datepicker.</span>
            <span class="keyword">var</span> <span class="variable">stats_endpoint</span> = <span class="this">this</span>.<span class="variable">stats_endpoint</span>;
            <span class="keyword">return</span> <span class="string">'/api/app/'</span>
                + <span class="this">this</span>.<span class="variable">app_id</span>
                + <span class="string">'/adunits/'</span>
                + <span class="string">'?'</span>
                + <span class="variable">window</span>.<span class="variable">location</span>.<span class="variable">search</span>.<span class="variable">substring</span>(<span class="number integer">1</span>)
                + <span class="string">'&amp;endpoint='</span>
                + <span class="variable">stats_endpoint</span>;
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>App</h2>

<p>We might consider turning derivative values (ecpm, fill_rate, ctr) into
functions.
     </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">App</span> = <span class="class">Backbone</span>.<span class="class">Model</span>.<span class="variable">extend</span>({
        <span class="variable">defaults</span> : {
            <span class="variable">name</span>: <span class="string">''</span>,
            <span class="variable">url</span>:<span class="string">'#'</span>,
            <span class="variable">icon_url</span>: &<span class="variable">quot</span>;<span class="regexp">/placeholders/image</span>.<span class="variable">gif</span>&<span class="variable">quot</span>;,
            <span class="variable">app_type</span>: <span class="string">'iOS'</span>,
            <span class="variable">active</span>: <span class="variable">false</span>,
            <span class="variable">attempts</span>: <span class="number integer">0</span>,
            <span class="variable">clicks</span>: <span class="number integer">0</span>,
            <span class="variable">ctr</span>: <span class="number integer">0</span>,
            <span class="variable">ecpm</span>: <span class="number integer">0</span>,
            <span class="variable">fill_rate</span>: <span class="number integer">0</span>,
            <span class="variable">impressions</span>: <span class="number integer">0</span>,
            <span class="variable">price_floor</span>: <span class="number integer">0</span>,
            <span class="variable">requests</span>: <span class="number integer">0</span>,
            <span class="variable">revenue</span>: <span class="number integer">0</span>,
            <span class="variable">stats_endpoint</span>: <span class="string">'all'</span>
        },
        <span class="variable">url</span>: <span class="keyword">function</span> () {
            <span class="keyword">var</span> <span class="variable">stats_endpoint</span> = <span class="this">this</span>.<span class="variable">get</span>(<span class="string">'stats_endpoint'</span>);
            <span class="keyword">return</span> <span class="string">'/api/app/'</span>
                + <span class="this">this</span>.<span class="variable">id</span>
                + &<span class="variable">quot</span>;?&<span class="variable">quot</span>;
                + <span class="variable">window</span>.<span class="variable">location</span>.<span class="variable">search</span>.<span class="variable">substring</span>(<span class="number integer">1</span>)
                + <span class="string">'&amp;endpoint='</span>
                + <span class="variable">stats_endpoint</span>;
        },
        <span class="variable">parse</span>: <span class="keyword">function</span> (<span class="variable">response</span>) {
            <span class="comment">// The api returns everything from this url as a list,</span>
            <span class="comment">// so that you can request one or all apps.</span>
            <span class="keyword">return</span> <span class="variable">response</span>[<span class="number integer">0</span>];
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>AppCollection</h2>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">AppCollection</span> = <span class="class">Backbone</span>.<span class="class">Collection</span>.<span class="variable">extend</span>({
        <span class="variable">model</span>: <span class="class">App</span>,
        <span class="comment">// If an app key isn't passed to the url, it'll return a list of all of the apps for the account</span>
        <span class="variable">url</span>: <span class="keyword">function</span>() {
            <span class="keyword">var</span> <span class="variable">stats_endpoint</span> = <span class="this">this</span>.<span class="variable">stats_endpoint</span>;
            <span class="keyword">return</span> <span class="string">'/api/app/'</span> +
                + <span class="string">'?'</span>
                + <span class="variable">window</span>.<span class="variable">location</span>.<span class="variable">search</span>.<span class="variable">substring</span>(<span class="number integer">1</span>)
                + <span class="string">'&amp;endpoint='</span>
                + <span class="variable">stats_endpoint</span>;
        },
        <span class="comment">// Not used anymore, but could come in handy</span>
        <span class="variable">fetchAdUnits</span>: <span class="keyword">function</span>() {
            <span class="this">this</span>.<span class="variable">each</span>(<span class="keyword">function</span> (<span class="variable">app</span>) {
                <span class="variable">app</span>.<span class="variable">adunits</span> = <span class="keyword">new</span> <span class="class">AdUnitCollection</span>();
                <span class="variable">app</span>.<span class="variable">adunits</span>.<span class="variable">app_id</span> = <span class="variable">app</span>.<span class="variable">id</span>;
                <span class="variable">app</span>.<span class="variable">adunits</span>.<span class="variable">fetch</span>();
            });
        }
    });</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Globalize. We should find a better way to do this.
     </p>
</td>
<td class="code">
<pre><code><span class="variable">window</span>.<span class="class">AdUnit</span> = <span class="class">AdUnit</span>;
    <span class="variable">window</span>.<span class="class">AdUnitCollection</span> = <span class="class">AdUnitCollection</span>;
    <span class="variable">window</span>.<span class="class">App</span> = <span class="class">App</span>;
    <span class="variable">window</span>.<span class="class">AppCollection</span> = <span class="class">AppCollection</span>;
    <span class="variable">window</span>.<span class="class">AdGroup</span> = <span class="class">AdGroup</span>;
    <span class="variable">window</span>.<span class="class">AdGroups</span> = <span class="class">AdGroups</span>;


})(<span class="this">this</span>.<span class="variable">jQuery</span>, <span class="this">this</span>.<span class="class">Backbone</span>, <span class="this">this</span>.<span class="variable">_</span>);</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="server/public/js/views.js"><a href="#">views</a></h2></td><td>server/public/js/views.js</td></tr><tr class="code">
<td class="docs">
<p>(function($, Backbone) {</p>
</td>
<td class="code">
<pre><code>
     * <span class="variable">collection</span>: <span class="class">AdGroups</span>
     * <span class="variable">el</span>: <span class="variable">element</span> <span class="variable">that</span> <span class="variable">will</span> <span class="variable">hold</span> <span class="variable">the</span> <span class="variable">content</span>
     * <span class="variable">title</span>: <span class="variable">title</span> <span class="variable">that</span> <span class="variable">will</span> <span class="variable">be</span> <span class="variable">an</span> <span class="variable">h2</span> <span class="variable">at</span> <span class="variable">the</span> <span class="variable">top</span> <span class="variable">of</span> <span class="variable">the</span> <span class="variable">content</span>
     * <span class="variable">type</span>: <span class="string">'network'</span>, <span class="string">'gtee'</span>, <span class="string">'promo'</span>, <span class="variable">or</span> <span class="string">'backfill_promo'</span> -- <span class="variable">affects</span> <span class="variable">which</span> <span class="variable">fields</span> <span class="variable">are</span> <span class="variable">shown</span>
     * <span class="variable">tables</span>: <span class="variable">mapping</span> <span class="variable">of</span>
     </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>var AdGroupsView = Backbone.View.extend({
        initialize: function() {
            this.collection.bind('change', this.render, this);
        },
        filtered<em>collection: function() {
            // TODO: uses elements not in this view
            var status = $("#campaigns-filterOptions").find(':checked').val();
            var app = $('#campaigns-appFilterOptions').val();
            return new AdGroups(this.collection.reject(function(adgroup) {
                return (status &amp;&amp; status != adgroup.get('status')) ||
                       (app &amp;&amp; adgroup.get('apps').indexOf(app) == -1);
            }));
        },
        render: function() {
            var adgroups = this.filtered</em>collection();</p>

<pre><code>        // TODO: uses elements not in this view, with multiple views there are conflicts
        $("#campaigns-filterOptions").buttonset({"disabled": !adgroups.isFullyLoaded()});

        var html;
        if(adgroups.size() === 0) {
            html = "&lt;h2&gt;No " + this.options.title + "&lt;/h2&gt;";
        }
        else {
            html = _.template($('#adgroups-rollup-template').html(), {
                adgroups: adgroups,
                title: this.options.title,
                type: this.options.type
            });
            if(this.options.tables) {
                var type = this.options.type;
                _.each(this.options.tables, function(filter, title) {
                    var filtered_adgroups = new AdGroups(adgroups.filter(filter));
                    if(filtered_adgroups.length) {
                        html += _.template($('#adgroups-table-template').html(), {
                            adgroups: filtered_adgroups,
                            title: title,
                            type: type
                        });
                    }
                });
            }
            else {
                html += _.template($('#adgroups-table-template').html(), {
                    adgroups: adgroups,
                    title: 'Name',
                    type: this.options.type
                });
            }
        }
        $(this.el).html(html);
        return this;
    }
});

var CollectionGraphView = Backbone.View.extend({
    initialize: function() {
        this.collection.bind('change', this.render, this);
    },

    show_chart: function() {
        if(this.collection.isFullyLoaded()) {
            mopub.Chart.setupDashboardStatsChart( ($('#dashboard-stats .stats-breakdown .active').attr('id') == 'stats-breakdown-ctr') ? 'line' : 'area');
        }
    },

    render: function() {
        if(this.collection.isFullyLoaded()) {
            // Breakdown
            $("#stats-breakdown-impression_count .all .inner").html(this.collection.get_formatted_stat('impression_count'));
            $("#stats-breakdown-revenue .all .inner").html(this.collection.get_formatted_stat('revenue'));
            $("#stats-breakdown-click_count .all .inner").html(this.collection.get_formatted_stat('click_count'));
            $("#stats-breakdown-ctr .all .inner").html(this.collection.get_formatted_stat('ctr'));
            if(this.options.yesterday != null &amp;&amp; this.options.today != null) {
                // yesterday
                $("#stats-breakdown-impression_count .yesterday .inner").html(this.collection.get_formatted_stat_for_day('impression_count', this.options.yesterday));
                $("#stats-breakdown-revenue .yesterday .inner").html(this.collection.get_formatted_stat_for_day('revenue', this.options.yesterday));
                $("#stats-breakdown-click_count .yesterday .inner").html(this.collection.get_formatted_stat_for_day('click_count', this.options.yesterday));
                $("#stats-breakdown-ctr .yesterday .inner").html(this.collection.get_formatted_stat_for_day('ctr', this.options.yesterday));
                // today
                $("#stats-breakdown-impression_count .today .inner").html(this.collection.get_formatted_stat_for_day('impression_count', this.options.today));
                $("#stats-breakdown-revenue .today .inner").html(this.collection.get_formatted_stat_for_day('revenue', this.options.today));
                $("#stats-breakdown-click_count .today .inner").html(this.collection.get_formatted_stat_for_day('click_count', this.options.today));
                $("#stats-breakdown-ctr .today .inner").html(this.collection.get_formatted_stat_for_day('ctr', this.options.today));
            }
            // Chart
            mopub.dashboardStatsChartData = {
                pointStart: this.options.start_date,
                pointInterval: 86400000,
                impression_count: this.collection.get_chart_data('impression_count'),
                revenue: this.collection.get_chart_data('revenue'),
                click_count: this.collection.get_chart_data('click_count'),
                ctr: this.collection.get_chart_data('ctr')
            };
            this.show_chart();
        }
    }
})</code></pre>
</td>
<td class="code">
<pre><code>
     * ## <span class="class">AppView</span>
     *
     * <span class="class">See</span> <span class="regexp">/partials/app</span>.<span class="variable">html</span> <span class="variable">to</span> <span class="variable">see</span> <span class="variable">how</span> <span class="this">this</span> <span class="variable">is</span> <span class="variable">rendered</span> <span class="keyword">in</span> <span class="class">HTML</span>.
     * <span class="class">This</span> <span class="variable">renders</span> <span class="variable">an</span> <span class="variable">app</span> <span class="variable">as</span> <span class="variable">a</span> <span class="variable">table</span> <span class="variable">row</span>. <span class="class">It</span> <span class="variable">also</span> <span class="variable">adds</span> <span class="variable">the</span> <span class="variable">call</span> <span class="variable">to</span> <span class="variable">load</span>
     * <span class="variable">adunits</span> <span class="variable">over</span> <span class="variable">ajax</span> <span class="variable">and</span> <span class="variable">put</span> <span class="variable">them</span> <span class="keyword">in</span> <span class="variable">the</span> <span class="variable">table</span>.
     </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>var AppView = Backbone.View.extend({</p>

<pre><code>    initialize: function () {
        this.template = _.template($('#app-template').html());
    },

    renderInline: function () {
        var app_row = $("tr.app-row#app-" + this.model.id, this.el);
        $(".revenue", app_row).text(mopub.Utils.formatCurrency(this.model.get("revenue")));
        $(".impressions", app_row).text(mopub.Utils.formatNumberWithCommas(this.model.get("impressions")));
        $(".ecpm", app_row).text(mopub.Utils.formatCurrency(this.model.get("ecpm")));
        $(".clicks", app_row).text(mopub.Utils.formatNumberWithCommas(this.model.get("clicks")));
        $(".ctr", app_row).text(mopub.Utils.formatNumberAsPercentage(this.model.get("ctr")));
        $(".fill_rate", app_row).text(mopub.Utils.formatNumberAsPercentage(this.model.get("fill_rate")));
        $(".requests", app_row).text(mopub.Utils.formatNumberWithCommas(this.model.get("requests")));

        return this;
    },
    render: function () {
        var renderedContent = $(this.template(this.model.toJSON()));

        // When we render an appview, we also attach a handler to fetch
        // and render it's adunits when a link is clicked.
        $('a.adunits', renderedContent).click(showAdUnits);
        $('tbody', this.el).append(renderedContent);
        return this;
    }
});</code></pre>
</td>
<td class="code">
<pre><code>
     * ## <span class="class">AppView</span> <span class="variable">helpers</span>
     *
     * <span class="class">Utility</span> <span class="variable">methods</span> <span class="keyword">for</span> <span class="class">AppView</span> <span class="variable">that</span> <span class="variable">control</span> <span class="variable">the</span> <span class="variable">showing</span>/<span class="variable">hiding</span>
     * <span class="variable">of</span> <span class="variable">adunits</span> <span class="variable">underneath</span> <span class="variable">an</span> <span class="variable">app</span> <span class="variable">row</span>.
     </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>function showAdUnits(event){
        event.preventDefault();
        var href = $(this).attr('href').replace('#','');
        Marketplace.fetchAdunitsForApp(href);
        $(this).text('Hide AdUnits').unbind("click").click(hideAdUnits);
    }</p>

<pre><code>function hideAdUnits(event){
    event.preventDefault();
    var href = $(this).attr('href').replace('#','');
    $.each($(".for-app-" + href), function (iter, item) {
        $(item).remove();
    });
    $("#app-" + href + " a.view_targeting").removeClass("hidden");
    $(this).text('Show Adunits').unbind("click").click(showAdUnits);
}</code></pre>
</td>
<td class="code">
<pre><code>
     * ## <span class="class">AdUnitView</span>
     *
     * <span class="class">See</span> <span class="regexp">/partials/adunit</span>.<span class="variable">html</span> <span class="variable">to</span> <span class="variable">see</span> <span class="variable">how</span> <span class="this">this</span> <span class="variable">is</span> <span class="variable">rendered</span> <span class="keyword">in</span> <span class="class">HTML</span>
     * <span class="class">Renders</span> <span class="variable">an</span> <span class="variable">adunit</span> <span class="variable">as</span> <span class="variable">a</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="variable">a</span> <span class="variable">table</span>. <span class="class">Also</span> <span class="variable">ads</span> <span class="variable">the</span> <span class="variable">event</span> <span class="variable">handler</span> <span class="variable">to</span>
     * <span class="variable">submit</span> <span class="variable">the</span> <span class="variable">price</span> <span class="variable">floor</span> <span class="variable">change</span> <span class="variable">over</span> <span class="variable">ajax</span> <span class="variable">when</span> <span class="variable">the</span> <span class="variable">price_floor</span> <span class="variable">field</span> <span class="variable">is</span> <span class="variable">changed</span>.
     </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>var AdUnitView = Backbone.View.extend({</p>

<pre><code>    initialize: function () {
        this.template = _.template($('#adunit-template').html());
    },</code></pre>
</td>
<td class="code">
<pre><code>
         * <span class="class">Render</span> <span class="variable">the</span> <span class="class">AdUnit</span> <span class="variable">into</span> <span class="variable">a</span> <span class="variable">table</span> <span class="variable">row</span> <span class="variable">that</span> <span class="variable">already</span> <span class="variable">exists</span>. <span class="class">Adds</span> <span class="variable">handlers</span>
         * <span class="keyword">for</span> <span class="variable">changing</span> <span class="class">AdUnit</span> <span class="variable">attributes</span> <span class="variable">over</span> <span class="variable">ajax</span>.
         </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>renderInline: function () {
            var current<em>model = this.model;
            var adunit</em>row = $("tr.adunit-row#adunit-" + this.model.id, this.el);
            $(".revenue", adunit<em>row).text(mopub.Utils.formatCurrency(this.model.get("revenue")));
            $(".ecpm", adunit</em>row).text(mopub.Utils.formatCurrency(this.model.get("ecpm")));
            $(".impressions", adunit<em>row).text(mopub.Utils.formatNumberWithCommas(this.model.get("impressions")));
            $(".price</em>floor", adunit<em>row).html('&lt;img class="loading-img hidden" ' +
                                               'src="/images/icons-custom/spinner-12.gif"&gt;' +
                                               '&lt;/img&gt; ' +
                                               '&lt;input id="'+ this.model.id + '" ' +
                                               'type="text" ' +
                                               'class="input-text input-text-number number" ' +
                                               'style="width:50px;margin: -3px 0;" ' +
                                               'value="' + this.model.get("price</em>floor") +
                                               '"&gt; ');
            $(".targeting", adunit_row).html('&lt;img class="loading-img hidden" ' +
                                             'src="/images/icons-custom/spinner-12.gif"&gt;&lt;/img&gt; ' +
                                             '&lt;input class="targeting-box" type="checkbox"&gt;');</p>

<pre><code>        $(".fill_rate", adunit_row).text(mopub.Utils.formatNumberAsPercentage(this.model.get("fill_rate")));
        $(".ctr", adunit_row).text(mopub.Utils.formatNumberAsPercentage(this.model.get("ctr")));
        $(".clicks", adunit_row).text(mopub.Utils.formatNumberWithCommas(this.model.get("clicks")));
        $(".requests", adunit_row).text(mopub.Utils.formatNumberWithCommas(this.model.get("requests")));

        if (this.model.get("active")) {
            $("input.targeting-box", adunit_row).attr('checked', 'checked');
        }

        // Add the event handler to submit targeting changes over ajax.
        $("input.targeting-box", adunit_row).click(function() {
            var loading_img = $(".targeting .loading-img", adunit_row);
            loading_img.show();
            current_model.set({'active': $(this).is(":checked")});
            current_model.save({}, {
                success: function () {
                    setTimeout(function() {
                        loading_img.hide();
                    }, 2000);
                }
            });
        });

        // Add the event handler to submit price floor changes over ajax.
        $('.price_floor .input-text', adunit_row).keyup(function() {
            var loading_img = $(".price_floor .loading-img", adunit_row);
            loading_img.show();
            current_model.set({'price_floor': $(this).val()});
            current_model.save({}, {
                success: function () {
                    setTimeout(function() {
                        loading_img.hide();
                    }, 2000);
                }
            });
        });

        return this;
    },</code></pre>
</td>
<td class="code">
<pre><code>
         * <span class="class">Render</span> <span class="variable">the</span> <span class="variable">adunit</span> <span class="variable">model</span> <span class="keyword">in</span> <span class="variable">the</span> <span class="variable">template</span>. <span class="class">This</span> <span class="variable">assumes</span> <span class="variable">that</span> <span class="variable">the</span> <span class="variable">table</span>
         * <span class="variable">row</span> <span class="keyword">for</span> <span class="variable">the</span> <span class="variable">app</span> <span class="variable">has</span> <span class="variable">already</span> <span class="variable">been</span> <span class="variable">rendered</span>. <span class="class">This</span> <span class="variable">will</span> <span class="variable">render</span> <span class="variable">underneath</span>
         * <span class="variable">it</span><span class="variable">s</span> <span class="variable">row</span>.
         </code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>render: function () {
            // render the adunit and attach it to the table after it's adunit's row
            var current_model = this.model;
            var renderedContent = $(this.template(this.model.toJSON()));</p>

<pre><code>        // Add the event handler to submit price floor changes over ajax.
        $('.price_floor_change', renderedContent)
            .change(function() {
                current_model.set({'price_floor': $(this).val()});
                // Save when they click the save button in the price floor cell
                var save_link = $(".save", $(this).parent());
                save_link.click(function(e) {
                    e.preventDefault();
                    save_link.addClass('disabled').text('Saving...');
                    current_model.save({}, {
                        success: function () {
                            setTimeout(function() {
                                save_link.removeClass('disabled').text('Saved');
                                save_link.text("Save");
                            }, 2000);
                        }
                    });
                });
            });

        // Add the event handler to submit targeting changes over ajax.
        $("input.targeting-box", renderedContent).click(function() {
            var targeting = $(this).attr('name');
            var activation = $(this).is(":checked") ? "On" : "Off";
            $("label[for='"+ targeting +"']", renderedContent).text(activation);

            current_model.set({'active': $(this).is(":checked")});
            current_model.save();
        });

        // Add the right background color based on where the app is in the table
        var app_row = $('tr#app-' + this.model.get('app_id'), this.el);
        var zebra = app_row.hasClass("even") ? "even" : "odd";
        renderedContent.addClass(zebra);

        app_row.after(renderedContent);

        return this;
    }
});

window.AdUnitView = AdUnitView;
window.AppView = AppView;
window.AdGroupsView = AdGroupsView;
window.CollectionGraphView = CollectionGraphView;</code></pre>

<p>})(this.jQuery, this.Backbone);</p>
</td>
<td class="code">

</td>
</tr>	</body>
</html></tbody></table>