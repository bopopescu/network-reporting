{% extends "base.html" %}
{% load filters %}

{% block pageTitle %}
  <h1>Marketplace</h1>
{% endblock pageTitle %}

{% block navLinks %}
  <li><a href="{% url publisher_index %}">Dashboard</a></li>
  <li><a href="{% url advertiser_campaign %}">Campaigns</a></li>
  <li class="active"><a href="{% url marketplace_index %}">Marketplace</a></li>
  <li><a href="{% url reports_index %}">Reports</a></li>
{% endblock navLinks %}

{% block messageCenter %} {% endblock messageCenter %}
{% block dateButtons %}

  <div id="titlebar-center">
    <span class="buttonset" id="dashboard-dateOptions">
      <input type="radio" name="dashboard-dateOptions-option" value="7" id="dashboard-dateOptions-option-7" {% ifequal date_range 7 %}checked="checked" {% endifequal %}/>
      <label for="dashboard-dateOptions-option-7">7 days</label>
      <input type="radio" name="dashboard-dateOptions-option" value="14" id="dashboard-dateOptions-option-14" {% ifequal date_range 14 %}checked="checked" {% endifequal %}{% if not date_range %}checked="checked" {% endif %}/>
      <label for="dashboard-dateOptions-option-14">14 days</label>
      <input type="radio" name="dashboard-dateOptions-option" value="30" id="dashboard-dateOptions-option-30" {% ifequal date_range 30 %}checked="checked" {% endifequal %}/>
        <label for="dashboard-dateOptions-option-30">30 days</label>
        <input type="radio" name="dashboard-dateOptions-option" value="custom" id="dashboard-dateOptions-option-custom" {% if date_range != 7 and date_range != 14 and date_range != 30 %}checked="checked" {% endif %}/>
        <label for="dashboard-dateOptions-option-custom">Custom ...</label>
      </span>
      <div id="dashboard-dateOptions-custom-modal">
        <div id="dashboard-dateOptions-custom-from"><h4>Start date:</h4></div>
        <div id="dashboard-dateOptions-custom-to"><h4>End date:</h4></div>
      </div>
    </div>
{% endblock dateButtons %}

{% block content %}

  {% if not marketplace.active %}
  <div class="alert-message block-message clearfix">
    {# <a href="#" class="close"> x </a> #}
    We've just launched MoPub Marketplace, our state of the art real-time bidding exchange.
    Flip the On/Off switch to get started,
    or take a look at our <a href="{% url mpx_info %}">information page</a> if you want to know more about how it works.
    <br />
    <div class="lightswitch right">
      <div class="switch off"></div>
    </div>
  </div>
  {% endif %}


  {% comment %}
    <div class="rollup fig3">
      <div class="data-figure">
        <div class="figure">
          {{ top_level_mpx_stats.impressions|withsep }}
        </div>
        <div class="label">
          Impressions
        </div>
      </div>

      <div class="data-figure">
        <div class="figure">
          {{ top_level_mpx_stats.ecpm }}
        </div>
        <div class="label">
          Average eCPM
        </div>
      </div>
      <div class="data-figure">
        <div class="figure">
          {{ top_level_mpx_stats.clicks|withsep }}
        </div>
        <div class="label">
          Clicks
        </div>
      </div>

      <div class="data-figure">
        <div class="figure">
          {{ top_level_mpx_stats.revenue|withsep }}
        </div>
        <div class="label">
          Revenue
        </div>
      </div>
    </div>
    {% endcomment %}


    <div class="campaignData-rollup">
      <table width=100% style='text-align:center; font-size:18px; font-weight:400;'>
        <thead>
          <tr style="border:none;">
            <th width=33%>Impressions</th>
            <th width=34%>eCPM</th>
            <th width=33%>Revenue</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border:none;">
            {% if top_level_mpx_stats %}
              <td> {{ top_level_mpx_stats.impressions|default_if_none:"0"|withsep }} </td>
              <td> {{ top_level_mpx_stats.ecpm|default_if_none:"0" }} </td>
              <td> {{ top_level_mpx_stats.revenue|default_if_none:"0"|withsep }} </td>
            {% else %}
              <td> 0 </td>
              <td> $0.00 </td>
              <td> $0.00 </td>
            {% endif %}
          </tr>
        </tbody>
      </table>
    </div>



  <ul class="tabs">
    <li class="active"> <a href="#performance"> App Performance </a> </li>
    <li> <a href="#controls"> Creative Performance </a> </li>
    <li> <a href="#settings"> Settings </a> </li>
  </ul>


  <div class="active tab-section" id="performance">


    <table class="simpletable" id="marketplace_stats" width="100%">

      <thead>
        <tr class="cmpaignData" style="border:none;">
          <th width="50"></th>
          <th>App</th>
          <th width="70" style="text-align: right";>Revenue</th>
          <th width="70" style="text-align: right";>eCPM</th>
          {# <th>Attempts</th> #}
          <th width="90" style="text-align: right";>Impressions</th>
          {# <th>Fill Rate</th> #}
          {# <th width="70" style="text-align: right";>Clicks</th> #}
          {# <th width="70" style="text-align: right";>CTR</th> #}
          <th width="130" style="text-align: right";>Price Floor</th>
          <th width="70"> Targeted </th>
        </tr>
      </thead>

      <tbody>
        {% for app in apps %}
        <tr class="app-row {% cycle 'odd' 'even' %}" id="app-{{ app.key }}" style="border:none;">
          <td class="icon">
            <img src="{{ app.icon_url }}" alt="Icon" width="45" height="45" class="app-icon" />
          </td>
          <td class="name">
            <a href="{% url publisher_app_show app.key %}" style="display:inline-block; max-width:250px;">{{ app.name }}</a>
            <span class="muted unbold"> ({{ app.app_type_text }}) </span>
            <img id="{{ app.key }}-img" src="/images/icons-custom/spinner-12.gif"></img>
            <br />
            <a href="#{{ app.key }}" class="adunits" id="{{app.key}}"> Show AdUnits </a>
          </td>
          <td class="revenue" style="text-align: right;">
            --
          </td>
          <td class="ecpm" style="text-align: right;">
            --
          </td>
          <td class="impressions" style="text-align: right;">
            --
          </td>

          {% comment %}
          <td class="clicks" style="text-align: right;">
            --
          </td>
          <td class="ctr" style="text-align: right;">
            --
          </td>
          {% endcomment %}
          <td class="price_floor" width="130" style="text-align: right">
            <a href="#{{ app.key }}" class="edit_price_floor" id="{{app.key}}"> Edit Price Floor</a>
          </td>
          <td class="targeting"> <a href="#{{ app.key }}" class="view_targeting" id="{{app.key}}"> View </a> </td>
        </tr>
      {% endfor %}
      </tbody>

    </table>

  </div>


  <div class="tab-section" id="controls">


    <table class="{#zebra-striped sortable simpletable#}" id="report-table" width="100%">
      <thead>
        <th> Creative </th>
        <th> Advertiser </th>
        <th> Revenue </th>
        <th> eCPM </th>
        <th> Impressions </th>
        {#<th> Clicks </th>#}
        {#<th> CTR </th>#}
      </thead>
      <tbody>
        {% comment %}
        {% for dsp in dsps %}
          {% for creative in dsp.creatives %}
            <tr>
              <td> {#<img src="/images/loading2.gif" />#} <iframe src="{{ creative.creative.url }}" width="320px" height="50px"></iframe>   </td>
              <td>
                {% if creative.creative.advertiser_blocked %}
                  {{ creative.creative.ad_dmn }}
                  (Blocked)
                {% else %} {% if creative.creative.ad_dmn %}
                {{ creative.creative.ad_dmn }}
                  <a href="#" id={{ creative.creative.ad_dmn }} class="block"> Block </a>
                {% else %}
                  --
                {% endif %}{% endif %}
              </td>
              <td style="text-align:right;"> {{ creative.stats.pub_rev|currency }} </td>
              <td style="text-align:right;"> {{ creative.stats.ecpm|currency }} </td>
              <td style="text-align:right;"> {{ creative.stats.imp }} </td>
              <td style="text-align:right;"> {{ creative.stats.clk }} </td>
              <td style="text-align:right;"> {{ creative.stats.ctr|percentage }} </td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
      <tfoot>
        <td> Totals </td>
        <td></td>
        <td> {{ creative_totals.pub_rev|currency }} </td>
        <td> {{ creative_totals.ecpm|currency }} </td>
        <td> {{ creative_totals.imp }} </td>
        <td> {{ creative_totals.clk }} </td>
        <td> {{ creative_totals.ctr|percentage }} </td>
      </tfoot>
      {% endcomment %}
    </table>

  </div>


  <div class="clearfix tab-section" id="settings">

    <h2> Marketplace Settings </h2>
    <div class="well">
      <div class="clearfix" style="width: 380px;">
        <div class="lightswitch left">
          <div class="switch {% if marketplace.active %}on{% else %}off{% endif %}"></div>
        </div>
        <div class="right label">
          Turn the Marketplace on or off for your account.
        </div>
      </div>

        {% comment %}>
      <br/>
      <form action="{% url marketplace_settings_change %}" method="POST" id="marketplace_settings_change">
        <input name="blind" type="checkbox" original-title="Coming Soon"/>
        <label for="blind"> Make my marketplace requests blind </label>

        <br />
        <input name="default_price_floor_activate" type="checkbox" />
        <input name="default_price_floor" type="text" />
        <label for="default_price_floor"> Set the default price floor for targeted adunits </label>
      </form>
        {% endcomment %}
    </div>

    <h2>Blocklist</h2>
    <div class="well">
      <div class="clearfix" style="width: 560px;">
        <div id="current_blocklist" class="right">
          <h3> Currently Blocked </h3>
          {% for domain in blocklist %}
            {{domain}}
            <a href="{% url remove_blocklist_handler %}?url={{ domain|escape }}">Remove</a>
            <br />
          {% empty %}
            There are no blocked advertisers
          {% endfor %}
        </div>



        <h3> Add blocked advertiser domains </h3>
        <textarea id="addblocklist" rows="10" cols="20" placeholder="Add blocked blocked advertiser domains here. You can add as many as you want at a time." name="blocklist"></textarea>

        <br />

        <a href="#" class="btn" id="blocklist-submit"> Add </a>


      </div>


    </div>

    {% comment %}
    <div class="right button-group">
      <div class="big disabled btn"> Discard Changes </div>
      <div id="settings-submit" class="big primary btn"> Save All Settings </div>
    </div>
    {% endcomment %}
  </div>

{% endblock content %}


{% block extraScripts %}
  <script type="text/html" id="app-template">
    {% include "partials/app.html" %}
  </script>
  <script type="text/html" id="adunit-template">
    {% include "partials/adunit.html" %}
  </script>

  <script src="/js/mopub-advertiser.js?v=80"></script>
  <script type="text/javascript" src="/js/underscore.min.js"></script>
  <script type="text/javascript" src="/js/json2.js"></script>
  <script type="text/javascript" src="/js/backbone.min.js"></script>
  <script type="text/javascript" src="/js/jquery.tipsy.js"></script>
  <script type="text/javascript" src="/js/mopub-marketplace.js"></script>
  <script type="text/javascript" src="/js/jquery.datatables.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      var app_keys = {{ app_keys|safe }};
      Marketplace.fetchAppStats(app_keys);

      var blocklist = {{ blocklist|safe }};


        table = $("#report-table").dataTable({
            "bProcessing": true,
            "bJQueryUI": true,
            "sPaginationType": "full_numbers",
            "oLanguage": {
                "sEmptyTable": "No creatives have been displayed for this time range."
            },
            "aoColumns":[
                {"sWidth": "330px"},
                {"sWidth": "190px"},
                {"sWidth": "120px"},
                {"sWidth": "90px"},
                {"sWidth": "90px"}
                //{"sWidth": "80px"},
                //{"sWidth": "80px"},
            ],
            "bAutoWidth":false,
            "aaSorting": [[2,'desc']],
            "sAjaxSource": "/api/creatives/",
            "fnRowCallback": function(nRow, aData, iDisplayIndex) {
                $("td:eq(0)", nRow).html("<iframe width='320px' height='50px' src='" + aData[0] + "'></iframe>");

                var domain = aData[1];
                if (_.contains(blocklist, domain)) {
                    $("td:eq(1)", nRow).text(aData[1] + " (Blocked)");
                } else if (domain !== null) {
                    $("td:eq(1)", nRow).html(domain);
                } else {
                    $("td:eq(1)", nRow).html("<span class='muted'>(Unknown)</span>");
                }
                $("td:eq(2)", nRow).addClass("numeric").text(mopub.Utils.formatCurrency(aData[2]));
                $("td:eq(3)", nRow).addClass("numeric");
                $("td:eq(4)", nRow).addClass("numeric");
                return nRow;
            }
        });

        $(".lightswitch").lightswitch(Marketplace.turnOn, Marketplace.turnOff);

    });
  </script>
{% endblock extraScripts %}

{% block extraCSS %}
<link rel="stylesheet" href="/css/dt_jui.css?v=7"></link>
{% endblock extraCSS %}

