{% load filters %}
<script type='text/javascript' src='/js/countries.js'></script>
<script type='text/javascript' src='/js/tokenize_in.js'></script>
 <link rel='stylesheet' type='text/css' href='/css/token-input-mopub.css'></link>
 <!-- <link rel='stylesheet' type='text/css' href='/css/token-input-mac.css'></link> -->
<script type='text/javascript'>
    var rgeourl = 'http://ws.geonames.org/findNearbyPlaceNameJSON?';
    var geo_s = 'http://ws.geonames.org/searchJSON?';
    $(document).ready( function () {
            var priors = {% if form.geo.value %}{{form.geo.value|safe}}{% else %}[]{% endif %};
            var city_priors = {% if form.cities.value %}{{form.cities.value|safe}}{% else %}[]{% endif %};
            var pre = {type: 'country', data: []};
            var city_pre = {type: 'city', data: []};
            //Not being used right now
            //var state_pre = {type: 'state', data: []};

            for (var count = 0; count < countries.length; count++) {
                var dat = countries[count];
                if ($.inArray(dat.code, priors) != -1) {
                    pre.data.push(dat);
                }
                if (pre.length == priors.length)
                    break;
            }
            //city is ll:ste:name:ccode;
            for (var i in city_priors) {
                if (city_priors.hasOwnProperty(i)) {
                    var datas = city_priors[i].split(':');
                    var ll = datas[0].split(',');
                    var ste = datas[1];
                    var name = datas[2];
                    var ccode = datas[3];
                    city_pre.data.push(
                            { lat: ll[0],
                              lng: ll[1],
                              countryCode: ccode,
                              adminCode1: ste,
                              name: name
                              });
                }
            }
           $('#city_ta').tokenInput(geo_s,
                    { country: 'US',
                      doImmediate: false,
                      hintText: 'Type in a city name',
                      queryParam: 'name_startsWith',
                      featureClass: 'P',
                      prePopulate: city_pre,
                      contentType: 'json',
                      type: 'city',
                      minChars: 3,
                      method: 'get'
              }); 
            //Verify that all cities in city_pre are in the SINGLE country that is pre

            //Need to create data object that is array of dictionary [ {name, id} ] 
                
            $('#geo_pred_ta').tokenInput( null, 
                            { data: countries,
                              hintText: 'Type in a country name',
                              formatResult: function( row ) {
                                    return row.name;
                                    },
                              formatMatch: function( row, i, max ){
                                    return [row.name, row.code];
                                    },
                              prePopulate: pre 
                });
                     /* Not doing states atm
            $('#state_ta').tokenInput(geo_s, { country: 'US',
                                              doImmediate: false,
                                              queryParam: 'name_startsWith',
                                              featureCode: 'ADM1',
                                              contentType: 'json',
                                              prePopulate: state_pre,
                                              type: 'state',
                                              minChars: 5,
                                              method: 'get'
                                              });
                                              */
            
    });
</script>
                    <dl class="formFields"> 
                      <dt><label for="TODO5">Ad Units:</label></dt>
                      <dd> 
                        <ul style="overflow:auto; max-height:200px; list-style: none;padding:5px 10px" class="{% if form.site_keys.errors %}form-error{% endif %}"> 
                        {% for adunit in all_adunits %}   
                          <li><input type="checkbox" name="site_keys" value="{{adunit.key}}"{% if adunit.checked %} checked="checked"{% endif %}> {{adunit.app.name}} &gt; {{adunit.name}} </input></li>   
                        {% endfor %}   
                        </ul>  
                        {% for error in form.site_keys.errors %}
                        <div class="form-error-text">{{error}}</div> 
                        {% endfor %}
                      </dd>
                      <div class="adgroupForm-advanced hidden">
                        <dt><label for="TODO6">Allocation:</label></dt>
                        <dd>
                          <input type="text" class="input-text input-text-number {% if form.allocation_percentage.errors %}form-error{% endif %}" name="{{form.allocation_percentage.name}}" value="{{form.allocation_percentage.value}}"/> % of all 
                          <select name="{{form.allocation_type.name}}">
                            <option value="users" {% if not form.allocation_type.value %}selected="selected"{% endif %}{% ifequal form.allocation_type.value 'users' %}checked="checked"{% endifequal %}>Users</option>
                            <option value="requests" {% ifequal form.allocation_type.value 'requests' %}selected="selected"{% endifequal %}>Requests</option>
                          </select>
                          {% for error in form.percent_users.errors %}
                          <div class="form-error-text">{{error}}</div> 
                          {% endfor %}
                        </dd>
                        
                        <dt><label for="TODO7">Frequency Caps:</label></dt>
                        <dd>
                          <input name="{{form.daily_frequency_cap.name}}" class="input-text input-text-number {% if form.daily_frequency_cap.errors %}form-error{% endif %}" type="text" value="{{form.daily_frequency_cap.value}}"/> daily impressions per user
                          {% for error in form.daily_frequency_cap.errors %}
                          <div class="form-error-text">{{error}}</div>
                          {% endfor %}
                        </dd>
                        <dt></dt>
                        <dd>
                          <input name="{{form.hourly_frequency_cap.name}}" class="input-text input-text-number {% if form.hourly_frequency_cap.errors %}form-error{% endif %}" type="text" value="{{form.hourly_frequency_cap.value}}"/> hourly impressions per user
                          {% for error in form.hourly_frequency_cap.errors %}
                          <div class="form-error-text">{{error}}</div> 
                          {% endfor %}
                        </dd> 
                      	{{ form.keywords|attrs:'{"placeholder":"Keywords, one per line, e.g. coffee"}' }}
                        <dt><label for="TODO9">
                        Country Targeting:
                        </label></dt>
                        <dd>
                          <div id='geo_pred_ta' name='geo_predicates'></div>
                          <!--
                          <textarea id='geo_pred_ta' name="geo_predicates" class="{% if form.geo_predicates.errors %}form-error{% endif %}">{% if form.geo_predicates.value %}{{form.geo_predicates.value}}{% else %}country_name=*{% endif %}</textarea> -->
                          {% for error in form.geo_predicates.errors %}
                          <div class="form-error-text">{{error}}</div>
                          {% endfor %}
                        </dd>
                        <div class="countryNumDependent 0 1" style='display:none;'>
                            <dt><label for="loc">Country Specificity:</label></dt>
                            <dd>
                                <span class="radios">
                                    <input type='radio' class='input-radio' name='location-targeting' value='all' id='advertiser-LocationSpec-all'{% if not form.cities.value %}checked{% endif %}></input>
                                    <label for='advertiser-LocationSpec-all'>Everywhere</label>
                                    <!--
                                    <input type='radio' class='input-radio' name='location-targeting' value='state' id='advertiser-LocationSpec-state'></input>
                                    <label for='advertiser-LocationSpec-state'>State/Province</label>
                                    --!>
                                    <input type='radio' class='input-radio' name='location-targeting' value='city' id='advertiser-LocationSpec-city'{% if form.cities.value %}checked{% endif %}></input>
                                    <label for='advertiser-LocationSpec-city'>City</label>
                                </span>
                            </dd>
                        </div>
                        <div class="locationDependent state" style='display:none;'>
                            <dt><label for='state_ta'>State/Province:</label></dt>
                            <dd><div id='state_ta'></div></dd>
                        </div>

                        <div class="locationDependent city" style='display:none;'>
                            <!-- nest so we can do the dependent stuff and only show if both
                                 without any more fancy logic --!>
                            <div class="countryNumDependent 1" style='display:none;'>
                                <dt><label for='city_ta'>City Targeting:</label></dt>
                                <dd><div id='city_ta'></div></dd>
                            </div>
                            <div class="countryNumDependent 0" style='display:none;'>
                                <dt><label for='city_ta_fake'>City Targeting:</label></dt>
                                <dd><div id='city_fake'>Please input a country</div></dd>
                            </div>
                        </div>

                        {# <dt><label for="TODO10">Device Predicates:</label></dt> #}
                        {# <dd> #}
                        {#   <textarea name="device_predicates" class="{% if form.device_predicates.errors %}form-error{% endif %}">{% if form.geo_predicates.value %}{{form.device_predicates.value}}{% else %}platform_name=*{% endif %}</textarea> #}
                        {#   <div>platform_name=(*,android,iphone)</div> #}
                        {#   {% for error in form.device_predicates.errors %} #}
                        {#   <div class="form-error-text">{{error}}</div> #}
                        {#   {% endfor %} #}
                        {# </dd> #}
                      </div>
                      <dt><a class="button button-small adgroupForm-advanced-toggleButton" id="adgroupForm-advanced-toggleButton" href="#">Show Advanced Targeting</a></dt> 
                      <dd></dd> 
                    </dl>
