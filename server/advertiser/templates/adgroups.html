{% extends 'advertiser/base.html' %}
{% load filters %}
{% load super_if %}

{% block extraScripts %}<script src="/js/mopub-advertiser.js?v=42"></script>
<script src='/js/tokenize_in.js'></script>
<script src='/js/countries.js'></script>
<script>
    $(function() {
        var graphStartDate = Date.UTC({{start_date.year}}, 
            {{start_date.month|add:"-1"}}, 
            {{start_date.day}});
        var campaignIdsToFetch = {};
        var fetchedCampaignIds = {};
        
        var AJAX_TIMEOUT_MILLISECONDS = 10000;
        var AJAX_MAX_FAILED_ATTEMPTS = 3;
        
        function getCampaignIds() {
            var dictionary = {};
            $(".campaignData").each(
                function() { 
                    var id = $(this).attr("id");
                    if (id && id != "") dictionary[id] = {};
                });
            return dictionary;
        }
        
        function getNumDays() {
            var daysRadioVal = $("input[name=dashboard-dateOptions-option]:checked").val();
            if (!daysRadioVal || daysRadioVal == "custom") {
                var currentUrl = document.location.href;
                var daysRegex = /r=(\d+)&/g;
                var match = daysRegex.exec(currentUrl);
                return match[1];
            }
            else return daysRadioVal;
        }
        
        function getStartDate() {
            var currentUrl = document.location.href;
            var startDateRegex = /s=(.*)(&|#)/g;
            var match = startDateRegex.exec(currentUrl);
            if (!match || match.length < 2) return null;
            else return match[1];
        }
        
        function populateCampaignStats(idsToFetch, fetchedIds) {
            var days = getNumDays();
            var startDate = getStartDate();
            
            for (var id in idsToFetch) {
                var backoffData = { delay: 1000, failedAttempts: 0 };
                ajaxFetchCampaign(id, days, startDate, idsToFetch, fetchedIds, backoffData);
            }
        }
        
        function ajaxFetchCampaign(id, days, startDate, idsToFetch, fetchedIds, backoffData) {
            var url = "/campaigns/stats/ajax/?adv=" + id + 
                "&date_range=" + days;
            if (startDate) url += "&start_date=" + startDate;
            
            $.ajax({
                url: url,
                dataType: 'json',
                success: function() {
                    return function(data) {
                        updateCampaign(data, idsToFetch, fetchedIds);
                    }
                }(),
                error: function() {
                    backoffData.failedAttempts++;
                    console.log("failed. num failures for this guy: ", backoffData.failedAttempts);
                    if (backoffData.failedAttempts > AJAX_MAX_FAILED_ATTEMPTS) {
                        console.log("maxed out failures, giving up...");
                        return;
                    } 
                    setTimeout(ajaxFetchCampaign(id, days, startDate, idsToFetch, fetchedIds, backoffData),
                        backoffData.delay);
                    backoffData.delay *= 1.5;
                    console.log("next backoff delay is: ", backoffData.delay)
                },
                timeout: AJAX_TIMEOUT_MILLISECONDS
            });
        }
        
        function updateCampaign(data, idsToFetch, fetchedIds) {
            var all_stats = data.all_stats;
            
            for (var key in all_stats) {
                var adgroup_id = key.split("||")[1];
                var sumStats = all_stats[key]["sum"];
                var formattedStats = formatStats(sumStats);
                
                for (var field in formattedStats) {
                    updateCampaignField(adgroup_id, field, formattedStats[field]);
                }
                
                // Record adgroup_id as fetched.
                console.log("deleting ", adgroup_id)
                delete idsToFetch[adgroup_id];
                fetchedIds[adgroup_id] = all_stats[key];
            }
            
            calculateRollupStats();
            var readyForRollups = objectIsEmpty(idsToFetch);
            if (readyForRollups) {
                prepareGraph();
            }
        }
        
        function objectIsEmpty(obj) {
            for (var key in obj) { 
                if (obj.hasOwnProperty(key)) return false;
            }
            return true;
        }
        
        function formatStats(sumStats) {
            var results = $.extend(true, {}, sumStats);
            results.impression_count = addCommas(results.impression_count);
            results.conversion_count = addCommas(results.conversion_count) + 
                " (" + formatPercentage(results.conv_rate) + ")";
            results.request_count = addCommas(results.request_count);
            results.click_count = addCommas(results.click_count);
            results.cpa = "$" + results.cpa.toFixed(2);
            results.cpc = "$" + results.cpc.toFixed(2);
            results.cpm = "$" + results.cpm.toFixed(2);
            results.ctr = formatPercentage(results.ctr);
            results.fill_rate = formatPercentage(results.fill_rate);
            results.on_schedule = (results.on_schedule) ? "On time" : "Behind";
            return results;
        }
        
        function updateCampaignField(adgroup, field, data) {
            if (!adgroup || adgroup == "") return;
            
            var classType = jsonKeyToClassMap[field];
            if (!classType || classType == "") return;
            
            var selector = "#" + adgroup + " ." + classType;
            $(selector).html(data);
        };
        
        var jsonKeyToClassMap = {
            status: "status",
            on_schedule: "on_schedule",
            revenue: "rev",
            impression_count: "imp",
            conversion_count: "conv",
            request_count: "req",
            click_count: "clk",
            cpa: "cpa",
            cpc: "cpc",
            cpm: "ecpm",
            ctr: "ctr",
            fill_rate: "fill",
        };
        
        function parseIntFromStatText(statText) {
            var stat = parseInt(statText.replace(/,/g,''), 10);
            return (isNaN(stat)) ? 0 : stat;
        }
        
        function calculateRollupStats() {
            // No need to calculate rollups when placeholder is visible, since there are no campaigns.
            if ($('.gtee-placeholder').is(":visible")) {
                $('#gtee-rollups').hide();
            }
            else {
                $('#gtee-rollups').show();
                var gtee_imp, gtee_clk, gtee_rev;
                gtee_imp = gtee_clk = gtee_rev = 0;
                $('.gtee-imp:visible').each(function() {
                        gtee_imp += parseIntFromStatText($(this).text());
                        });
                $('.gtee-clk:visible').each(function() {
                        gtee_clk += parseIntFromStatText($(this).text());
                        });
                $('tr.gtee_row:visible td.gtee-rev').each(function() {
                        gtee_rev += parseIntFromStatText($(this).text());
                        });

                $('#gtee-total-imp').text(addCommas(gtee_imp));
                $('#gtee-total-clk').text(addCommas(gtee_clk));
                $('#gtee-total-rev').text('$'+addCommas(Math.round(gtee_rev*100)/100));
                var gtee_ctr;
                if (gtee_clk === 0) {
                    gtee_ctr = formatPercentage(0);
                }
                else {
                    gtee_ctr = formatPercentage(gtee_clk/gtee_imp, 2);
                }
                $('#gtee-total-ctr').text(gtee_ctr);
            }


            if ($('.bfill-placeholder').is(":visible")) {
                $('#bfill-rollups').hide();
            }
            else {
                $('#bfill-rollups').show();
                var bfill_imp, bfill_clk, bfill_conv;
                bfill_imp = bfill_clk = bfill_conv = 0;
                $('.bfill-imp:visible').each(function() {
                        bfill_imp += parseIntFromStatText($(this).text());
                        });
                $('.bfill-clk:visible').each(function() {
                        bfill_clk += parseIntFromStatText($(this).text());
                        });
                $('.bfill-conv:visible').each(function() {
                        bfill_conv += parseIntFromStatText($(this).text());
                        });

                $("#bfill-total-imp").text(addCommas(bfill_imp));
                $("#bfill-total-clk").text(addCommas(bfill_clk));
                $("#bfill-total-conv").text(addCommas(bfill_conv));
                var bfill_ctr;
                if (bfill_clk === 0) {
                    bfill_ctr = formatPercentage(0);
                }
                else {
                    bfill_ctr = formatPercentage(bfill_clk/bfill_imp);
                }
                $("#bfill-total-ctr").text(bfill_ctr);
            }

            if ($('.promo-placeholder').is(":visible")) {
                $('#promo-rollups').hide();
            }
            else {
                $('#promo-rollups').show();
                var promo_imp, promo_clk, promo_conv;
                promo_imp = promo_clk = promo_conv = 0;
                $('.promo-imp:visible').each(function() {
                        promo_imp += parseIntFromStatText($(this).text());
                        });
                $('.promo-clk:visible').each(function() {
                        promo_clk += parseIntFromStatText($(this).text());
                        });
                $('.promo-conv:visible').each(function() {
                        promo_conv += parseIntFromStatText($(this).text());
                        });

                $("#promo-total-imp").text(addCommas(promo_imp));
                $("#promo-total-clk").text(addCommas(promo_clk));
                $("#promo-total-conv").text(addCommas(promo_conv));
                var promo_ctr;
                if (promo_clk === 0) {
                    promo_ctr = formatPercentage(0);
                }
                else {
                    promo_ctr = formatPercentage(promo_clk/promo_imp);
                }
                $("#promo-total-ctr").text(promo_ctr);
            }



            if ($('.network-placeholder').is(":visible")) {
                $('#network-rollups').hide();
            }
            else {
                $('#network-rollups').show();
                var net_imp, net_clk, net_req;
                net_imp = net_clk = net_req = 0;
                $('.network-imp').each(function() {
                        net_imp += parseIntFromStatText($(this).text());
                        });
                $('.network-clk').each(function() {
                        net_clk += parseIntFromStatText($(this).text());
                        });
                $('.network-req').each(function() {
                        net_req += parseIntFromStatText($(this).text());
                        });
                $("#network-total-imp").text(addCommas(net_imp));
                $("#network-total-clk").text(addCommas(net_clk));
                var net_ctr;
                if (net_clk === 0) {
                    net_ctr = formatPercentage(0);
                }
                else {
                    net_ctr = formatPercentage(net_clk/net_imp);
                }
                $("#network-total-ctr").text(net_ctr);
                var net_fill;
                if (net_imp === 0) {
                    net_fill = formatPercentage(0);
                }
                else {
                    net_fill = formatPercentage(net_imp/net_req);
                }
                $('#network-total-fill').text(net_fill + ' (' + addCommas(net_req) + ')');
            }
        }
    
        function addCommas(numberString)
        {
            numberString += '';
            x = numberString.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }

        function formatPercentage(number){
            // We round to two decimal places
            return (number*100).toFixed(2) + '%';
        }
        
        function prepareGraph() {
            var topCampaigns = getTopCampaigns(4);
            
            var graphImpStats = getGraphStatsForStatName("impression_count", topCampaigns);
            var graphRevStats = getGraphStatsForStatName("revenue", topCampaigns);
            var graphClkStats = getGraphStatsForStatName("click_count", topCampaigns);
            var graphCtrStats = getGraphStatsForStatName("ctr", topCampaigns);
            
            mopub.dashboardStatsChartData = {
                pointStart: graphStartDate,
                pointInterval: 86400000,
                impressions: graphImpStats,
                revenue: graphRevStats,
                clicks: graphClkStats,
                ctr: graphCtrStats
            };
            
            var chartSeriesType = 'area';
            var activeBreakdownsElem = $('#dashboard-stats .stats-breakdown .active');
            if (activeBreakdownsElem.attr('id') == 'stats-breakdown-ctr') chartSeriesType = 'line';
            setupDashboardStatsChart(chartSeriesType);
        }
        
        function getTopCampaigns(numCampaigns) {
            var campaigns = [];
            $.each(fetchedCampaignIds, function(key, value) {
                var dict = {};
                dict.key = value["name"].replace("||", "");
                dict.stats = value;
                campaigns.push(dict);
            });
            
            campaigns.sort(function(a, b) {
                var impsA = parseInt(a.stats.sum.impression_count);
                var impsB = parseInt(b.stats.sum.impression_count);
                if (impsA < impsB) return 1;
                if (impsA > impsB) return -1;
                else return 0;
            });
            
            numCampaigns = (numCampaigns < campaigns.length) ? numCampaigns : campaigns.length;
            return campaigns.slice(0, numCampaigns);
        }
        
        function getGraphStatsForStatName(statName, topCampaigns) {
            var statsArray = [];
            
            for (var i = 0; i < topCampaigns.length; i++) {
                var campaign = topCampaigns[i];
                var name = campaign.key;
                var daily_stats = campaign.stats.daily_stats;
                var dict = {};
                dict[name] = $.map(daily_stats, function(dayStats) {
                    return parseInt(dayStats[statName]);
                });
                statsArray.push(dict);
            }
            
            return statsArray;
        }
        
        function populateStatsBreakdowns() {
            var days = getNumDays();
            var startDate = getStartDate();
            var backoffData = { delay: 1000, failedAttempts: 0 };
            
            ajaxFetchStatsBreakdowns(days, startDate, backoffData);
        }
        
        function ajaxFetchStatsBreakdowns(days, startDate, backoffData) {
            var url = "/campaigns/stats/ajax/?date_range=" + days;
            if (startDate) url += "&start_date=" + startDate;
            
            $.ajax({
                url: url,
                dataType: 'json',
                success: updateStatsBreakdowns,
                error: function() {
                    backoffData.failedAttempts++;
                    console.log("failed. num failures for stats breakdowns: ", backoffData.failedAttempts);
                    if (backoffData.failedAttempts > AJAX_MAX_FAILED_ATTEMPTS) {
                        console.log("maxed out failures for stats breakdowns, giving up...");
                        return;
                    } 
                    setTimeout(ajaxFetchStatsBreakdowns(days, startDate, backoffData),
                        backoffData.delay);
                    backoffData.delay *= 1.5;
                    console.log("next backoff delay for stats breakdowns is: ", backoffData.delay);
                },
                timeout: AJAX_TIMEOUT_MILLISECONDS
            });
        }
        
        function updateStatsBreakdowns(data) {
            var all_stats = data.all_stats["||"];
            var daily_stats = all_stats.daily_stats;
            var today = formatStats(daily_stats[daily_stats.length - 1]);
            var yesterday = formatStats(daily_stats[daily_stats.length - 2]);
            var all = formatStats(all_stats.sum);
            
            $("#stats-breakdown-impressions .today .inner").html(today.impression_count);
            $("#stats-breakdown-revenue .today .inner").html("$" + today.revenue.toFixed(2));
            $("#stats-breakdown-clicks .today .inner").html(today.click_count);
            $("#stats-breakdown-ctr .today .inner").html(today.ctr);
            
            $("#stats-breakdown-impressions .yesterday .inner").html(yesterday.impression_count);
            $("#stats-breakdown-revenue .yesterday .inner").html("$" + yesterday.revenue.toFixed(2));
            $("#stats-breakdown-clicks .yesterday .inner").html(yesterday.click_count);
            $("#stats-breakdown-ctr .yesterday .inner").html(yesterday.ctr);
            
            $("#stats-breakdown-impressions .all .inner").html(all.impression_count);
            $("#stats-breakdown-revenue .all .inner").html("$" + all.revenue.toFixed(2));
            $("#stats-breakdown-clicks .all .inner").html(all.click_count);
            $("#stats-breakdown-ctr .all .inner").html(all.ctr);
        }
        
        populateStatsBreakdowns();
        campaignIdsToFetch = getCampaignIds();
        populateCampaignStats(campaignIdsToFetch, fetchedCampaignIds);
        
        /*---------------------------------------/
        / Chart
        /---------------------------------------*/

        function chartError() {
          //$('#dashboard-stats-chart').removeClass('chart-loading').addClass('chart-error');
        }

        function setupDashboardStatsChart(seriesType) {
          // get active metric from breakdown
          var metricElement = $('#dashboard-stats .stats-breakdown .active');
          var metricElementIdComponents = metricElement.attr('id').split('-');
          var activeMetric = metricElementIdComponents[metricElementIdComponents.length - 1];

          // get data
          var data = mopub.dashboardStatsChartData;
          if(typeof data == 'undefined') {
            chartError();
            return;
          }

          // set up series
          var colors = ['#0090d9', '#e57300', '#53a600', '#444444'];
          var chartSeries = [];
          var activeData = data[activeMetric];
          if(typeof activeData == 'undefined') {
            chartError();
            return;
          }
          $.each(activeData, function(i, seriesObject) {
            var seriesName, seriesData;
            $.each(seriesObject, function(name, value) {
              seriesName = name;
              seriesData = value;

              if (seriesType == 'line'){
                 if (seriesName == 'Mopub Optimized'){
                  seriesLineWidth = 4;
                } else{
                  seriesLineWidth = 2;
                }
              }
              else{
                seriesLineWidth = 3;
              }

            });
            chartSeries.push({
              name: seriesName,
              data: seriesData,
              color: colors[i],
              lineWidth: seriesLineWidth,
            });
          });

          // setup HighCharts chart
          this.trafficChart = new Highcharts.Chart({
            chart: {
              renderTo: 'dashboard-stats-chart',
              defaultSeriesType: seriesType,
              marginTop: 0,
              marginBottom: 55
            },
            plotOptions: {
              series: {
                pointStart: data.pointStart,
                pointInterval: data.pointInterval
              }
            },
            legend: {
              verticalAlign: "bottom",
              y: -7,
              enabled: (chartSeries.length > 1)          
            },
            yAxis: {
              labels: {
                formatter: function() {
                  if(activeMetric == 'revenue') {
                    text = '$' + Highcharts.numberFormat(this.value, 0);
                  }
                  else if(activeMetric == 'ctr') {
                    text = Highcharts.numberFormat(this.value, 0) + '%';
                  } 
                  else {
                    if (this.value >= 1000000000) {
                      return Highcharts.numberFormat(this.value / 1000000000, 0) + "B";
                    } else if (this.value >= 1000000) {
                      return Highcharts.numberFormat(this.value / 1000000, 0) + "M";
                    } else if (this.value >= 1000) {
                      return Highcharts.numberFormat(this.value / 1000, 0) + "K";
                    } else if (this.value > 0) {
                      return Highcharts.numberFormat(this.value, 0);
                    } else {
                      return "0";
                    }
                  }
                }
              }
            },
            tooltip: {
              formatter: function() {
                var text = '', value = '', total = '';

                if(activeMetric == 'revenue') {
                  value = '$' + Highcharts.numberFormat(this.y, 0);
                  total = '$' + Highcharts.numberFormat(this.total, 0) + ' total';
                }
                else if (activeMetric == 'clicks') {
                  value = Highcharts.numberFormat(this.y, 0) + ' ' + activeMetric;
                  total = Highcharts.numberFormat(this.total, 0) + ' total ' + activeMetric;
                }
                else if (activeMetric == 'ctr') {
                  value = Highcharts.numberFormat(this.y*100, 2) + "% click through";
                  total = "";
                }
                else {
                  value = Highcharts.numberFormat(this.y, 0) + ' ' + activeMetric;
                  total = Highcharts.numberFormat(this.total, 0) + ' total ' + activeMetric;
                }

                text += '<span style="font-size: 14px;">' + Highcharts.dateFormat('%A, %B %e, %Y', this.x) + '</span><br/>';
                text += '<span style="padding: 0; font-weight: 600; color: ' + this.series.color + '">' + this.series.name + '</span>' + ': <strong style="font-weight: 600;">' + value + '</strong><br/>';

                if((chartSeries.length > 1) && (total != "")) {
                  text += '<span style="font-size: 12px; color: #666;">';
                  if(this.total > 0) {
                    text += '(' + Highcharts.numberFormat(this.percentage, 0) + '% of ' + total + ')';
                  }
                  else {
                    text += '(' + total + ')';
                  }
                  text += '</span>';
                }

                return text;
              }
            },
            series: chartSeries
          });

          $('#dashboard-stats-chart').removeClass('chart-loading');
        }
        if ($('#dashboard-stats').length){
          setupDashboardStatsChart('area');
        }

        // Use breakdown to switch charts
        $('.stats-breakdown tr:not(#stats-breakdown-ctr)').click(function(e) {
          $('#dashboard-stats-chart').fadeOut('fast', function() {
            setupDashboardStatsChart('area');
            $(this).fadeIn('fast');
          });
        });

        // Remove the standard click handler and replace it
        $('#stats-breakdown-ctr').click(function(){
            $('#dashboard-stats-chart').fadeOut('fast', function(){
                setupDashboardStatsChart('line');
                $(this).fadeIn('fast');
            });
        });
    });
</script>
{% endblock extraScripts %}

{% block navLinks %}
<li><a href="{% url publisher_index %}">Dashboard</a></li>
<li class="active"><a href="{% url advertiser_campaign %}">Campaigns</a></li>
<li><a href="{% url reports_index %}">Reports</a></li>
{% endblock navLinks %}
{% block pageTitle %}<h1>{% ifequal account.status 'step4' %}Step 4: Set up an ad campaign{% else %}Campaigns{% endifequal %}</h1>{% endblock pageTitle %}
{% block titleBarRight %}
    {% ifequal account.status 'step4' %}
            <div class="stepProgress"> 
              <span class="stepProgress-step">Step 1: Add app</span> 
              <span class="ui-icon ui-icon-arrow-1-e"></span> 
              <span class="stepProgress-step">Step 2: Integrate</span> 
              <span class="ui-icon ui-icon-arrow-1-e"></span> 
              <span class="stepProgress-step">Step 3: Ad networks</span> 
              <span class="ui-icon ui-icon-arrow-1-e"></span> 
              <span class="stepProgress-step stepProgress-active">Step 4: Ad campaigns</span> 
            </div>
    {% else %}        
        <span class="titlebar-right">
            <a class="button" id="advertisers-testAdServer" href="#">Test Campaigns</a>
        </span>
    {% endifequal %}
            
{% endblock titleBarRight %}
    
    
{% block messageCenter %}{% endblock messageCenter %}
{% block dateButtons %}{% ifnotequal account.status 'step4' %}
          <div id="titlebar-center">
            <span class="buttonset" id="dashboard-dateOptions">
              <input type="radio" name="dashboard-dateOptions-option" value="7" id="dashboard-dateOptions-option-7" {% ifequal date_range 7 %}checked="checked" {% endifequal %}/>
              <label for="dashboard-dateOptions-option-7">7 days</label>
              <input type="radio" name="dashboard-dateOptions-option" value="14" id="dashboard-dateOptions-option-14" {% ifequal date_range 14 %}checked="checked" {% endifequal %}{% if not date_range %}checked="checked" {% endif %}/>
              <label for="dashboard-dateOptions-option-14">14 days</label>
              <input type="radio" name="dashboard-dateOptions-option" value="30" id="dashboard-dateOptions-option-30" {% ifequal date_range 30 %}checked="checked" {% endifequal %}/>
              <label for="dashboard-dateOptions-option-30">30 days</label>
              <input type="radio" name="dashboard-dateOptions-option" value="custom" id="dashboard-dateOptions-option-custom" />
              <label for="dashboard-dateOptions-option-custom">Custom ...</label>
            </span>
            <div id="dashboard-dateOptions-custom-modal">
              <div id="dashboard-dateOptions-custom-from"><h4>Start date:</h4></div>
              <div id="dashboard-dateOptions-custom-to"><h4>End date:</h4></div>
            </div>
          </div>
{% endifnotequal %}{% endblock dateButtons %}

{% block content %}{% ifequal account.status "step4" %}
          <div class="alertMessage">
            Finally, you will need to set up at least one ad campaign to serve into your inventory.  A <strong>Guaranteed</strong> ad campaign is typically a direct sold ad campaign.  <strong>Promotional</strong> campaigns are for house ads like an upsell.  A <strong>Network</strong> ad is an ad served from a ad network like AdMob.
          </div>
{% endifequal %}
{% ifequal account.status "step3" %}
          <div class="alertMessage">
            The next step is to set up your ad networks.  Visit your <a href="{% url account_index %}">Account</a> page to enable your ad networks.
          </div>
{% endifequal %}
{% if not apps %}
          <div class="alertMessage">
            Before you set up your ad campaigns, we recommend that you set up your App inventory.  Visit the <a href="{% url publisher_index %}">Dashboard</a> to add your Apps.
          </div>
{% endif %}
          <div class="separated">
            <section class="offset nomargin" id="dashboard-stats">
              <h3 class="stats-chart-title">Realtime Stats for {{start_date|format_date_compact}} to {{end_date|format_date_compact}}</h3>
              <div class="stats">
                <div class="stats-breakdown stats-breakdown-4">
                  <table>
                    <tbody>
                      <tr class="active" id="stats-breakdown-impressions">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">Impressions</span></th>
                      </tr>
                      <tr id="stats-breakdown-revenue">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">Revenue</span></th>
                      </tr>
                      <tr id="stats-breakdown-clicks">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">Clicks</span></th>
                      </tr>
                      <tr id="stats-breakdown-ctr">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">CTR</span></th>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="stats-breakdown-buttons">
                  <span class="buttonset button-small" id="stats-breakdown-dateOptions">
                    <input type="radio" name="stats-breakdown-dateOptions-option" value="today" id="stats-breakdown-dateOptions-option-0" checked="checked"/>
                    <label for="stats-breakdown-dateOptions-option-0">Today</label>
                    <input type="radio" name="stats-breakdown-dateOptions-option" value="yesterday" id="stats-breakdown-dateOptions-option-1"/>
                    <label for="stats-breakdown-dateOptions-option-1">Yesterday</label>
                    <input type="radio" name="stats-breakdown-dateOptions-option" value="all" id="stats-breakdown-dateOptions-option-2"/>
                    <label for="stats-breakdown-dateOptions-option-2">All</label>
                  </span>
                </div>
                <div class="chart chart-loading stats-chart" id="dashboard-stats-chart">
                  <div class="chart-loading-text">Loading ...</div>
                  <div class="chart-error-text">Could not load chart</div>
                </div>
              </div>
              <div class="clear"></div>
            </section>
          </div>
          <section id="dashboard-campaigns">
            <div id="campaigns-control-panel">
              <div class="center-button-bank">
    
                <span class="buttonset inactive" id="campaigns-filterOptions"> 
                  <input type="radio" name="campaigns-filterOptions-option" value="campaign-status-all" checked="checked" id="campaigns-filterOptions-option-all"/> 
                  <label for="campaigns-filterOptions-option-all">All</label> 
                  <input type="radio" name="campaigns-filterOptions-option" value="campaign-status-Running" id="campaigns-filterOptions-option-Running"/> 
                  <label for="campaigns-filterOptions-option-Running">Running</label> 
                  <input type="radio" name="campaigns-filterOptions-option" value="campaign-status-Paused" id="campaigns-filterOptions-option-Paused" /> 
                  <label for="campaigns-filterOptions-option-Paused">Paused</label> 
                  <input type="radio" name="campaigns-filterOptions-option" value="campaign-status-Scheduled" id="campaigns-filterOptions-option-Scheduled" /> 
                  <label for="campaigns-filterOptions-option-Scheduled">Scheduled</label> 
                </span>
              
                <select name="campaigns-appFilterOptions" id="campaigns-appFilterOptions"> 
                            <option id="campaigns-appFilterOptions-option-all" value="campaign-status-all">All Apps</option>
                                {% for app in apps %}
                                <option value="campaign-targeting-{{app.key}}">{{app.name}}</option> 
                                {% endfor %}
                        </select>
              </div>
               <a class="button" id="advertisers-addCampaign" href="{% url advertiser_campaign_create %}">Add a campaign</a>
            </div>
            
            <div id="adserverTest" style="display:none;">
                <iframe height="480" width="350" id="adserverTest-iFrame" scrolling="no">
                </iframe>    
                <div id="adserverTest-iFrame-src" style="display:none;">{% url advertiser_adserver_test %}</div>    
            </div>    
            
            <form method="post" action="{% url advertiser_bid_pause %}" id="campaignForm">
              <input type="hidden" name="action" id="action"/>
              <h2>Guaranteed</h2>
              <div id='gtee-rollups' class="campaignData-rollup">
                  <table width=100% style='text-align:center; font-size:18px; font-weight:400;'>
                      <thead>
                          <tr>
                              <th width=25%>Impressions</th>
                              <th width=25%>Clicks</th>
                              <th width=25%>CTR</th>
                              <th width=25%>Revenue</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td id='gtee-total-imp'></td>
                              <td id='gtee-total-clk'></td>
                              <td id='gtee-total-ctr'></td>
                              <td id='gtee-total-rev'></td>
                          </tr>
                      </tbody>
                  </table>
              </div>

              {% for level in guarantee_levels %}
              {% if level.display %} 
              <table class="dataTable campaignData-main" id="campaignDataTable-direct-{{level.name}}">
                    <thead>
                      <tr>
                        <th class="campaignData-icon"></th>
                        <th class="dataTable-name">{{level.name}} Priority</th>
                        <th class="dataTable-data numeric">eCPM</th>
                        <th class="dataTable-data numeric">Status</th>
                        <th class="dataTable-data numeric">Impressions</th>
                        <th class="dataTable-data numeric">Clicks</th>
                        <th class="dataTable-data numeric">CTR</th>
                        <th class="dataTable-data numeric">Conv</th>
                        <th class="dataTable-data numeric">CPA</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for adgroup in level.adgroups %}

                      <tr class="campaignData gtee_row campaign-status-all campaign-targeting-all
                      {% for app_key in adgroup.targeted_app_keys %} campaign-targeting-{{ app_key }} {% endfor %}"
                      id="{{adgroup.key}}">
                        <th class="campaignData-icon">
                            <input type="checkbox" name="id" value="{{adgroup.key}}"/>
                            {% if adgroup.deleted %}<img src="/images/deleted.gif" height=9 width=9 />{% endif %}
                            {% if adgroup.active and not adgroup.deleted %}<img src="/images/active.gif" height=9 width=9 />{% endif %}
                            {% if not adgroup.active and not adgroup.deleted %}<img src="/images/paused.gif" height=9 width=9 />{% endif %}
                        </th> 
                        <th class="dataTable-name">
                            <a href="{% url advertiser_adgroup_show adgroup_key=adgroup.key %}">{{adgroup.name}}</a><br/>
                            <span class="muted">
                                {% if adgroup.campaign.start_date and adgroup.campaign.end_date %}
                                {{adgroup.campaign.start_date|format_date_compact}}-{{adgroup.campaign.end_date|format_date_compact}}.
                                {% endif %} {% if adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                                Starts {{adgroup.campaign.start_date|format_date_compact}}.
                                {% endif %} {% if not adgroup.campaign.start_date and adgroup.campaign.end_date %}
                                Ends {{adgroup.campaign.start_date|format_date_compact}}.
                                {% endif %} {% if not adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                                All dates.
                                {% endif %}
                                {% ifequal adgroup.campaign.budget_type 'daily' %}{% if adgroup.campaign.budget %}{{adgroup.campaign.budget|currency}} daily budget.{% else %} Unlimited budget.{% endif %}{% endifequal %}
                                {% ifequal adgroup.campaign.budget_type 'full_campaign' %}{{adgroup.campaign.full_budget|currency}} campaign budget.{% endifequal %}
                            </span>
                        </th>

                        {% if adgroup.cpc %}
                        <td class="dataTable-data numeric dataTable-ecpm">
                          <span class="dataTable-campaign-ecpm ecpm">
                            --
                            <a href="#" id="campaign-ecpm-helpLink" class="whatsthis">
                              <div class="whatsthis-icon"></div>
                            </a>
                          </span>
                        </td>
                        {% else %}
                        <td class="dataTable-data numeric dataTable-ecpm ecpm">--</td>
                        {% endif %}
                        
                        <td class="dataTable-data numeric">
                            <div class="status">Loading...</div>
                            <div class="on_schedule muted"></div>
                        </td>
                        <td class='gtee-rev rev' style='display:none;'></td>
                        <td class="dataTable-data numeric gtee-imp imp">--</td>
                        <td class="dataTable-data numeric gtee-clk clk">--</td>
                        <td class="dataTable-data numeric gtee-ctr ctr">--</td>
                        <td class="dataTable-data numeric gtee-conv conv">--</td>
                        <td class="dataTable-data numeric gtee-cpa cpa">--</td>
                      </tr>
                      {% endfor %}
                      <tr class="campaignData campaignData-placeholder gtee-placeholder">
                        <th class="campaignData-icon"></th>
                        <th class="dataTable-name"><span class="muted">None</span></th>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                        <td class="dataTable-data numeric"></td>
                      </tr>
                      {% endif %}
                {% endfor %}
                </tbody>
              </table>
              <h2>Promotional</h2>
              <div id='promo-rollups' class="campaignData-rollup">
                  <table width=100% style='text-align:center; font-size:18px; font-weight:400;'>
                      <thead>
                          <tr>
                              <th width=25%>Impressions</th>
                              <th width=25%>Clicks</th>
                              <th width=25%>CTR</th>
                              <th width=25%>Conversions</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td id='promo-total-imp'></td>
                              <td id='promo-total-clk'></td>
                              <td id='promo-total-ctr'></td>
                              <td id='promo-total-conv'></td>
                              <td></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              <table class="dataTable campaignData-main">
                <thead>
                  <tr>
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name">Name</th>
                    <th class="dataTable-data numeric">eCPM</th>
                    <th class="dataTable-data numeric">Status</th>
                    <th class="dataTable-data numeric">Impressions</th>
                    <th class="dataTable-data numeric">Clicks</th>
                    <th class="dataTable-data numeric">CTR</th>
                    <th class="dataTable-data numeric">Conv</th>
                    <th class="dataTable-data numeric">CPA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for adgroup in promo %}
                  <tr class="campaignData promo_row campaign-status-all campaign-targeting-all
                    {% for app_key in adgroup.targeted_app_keys %} campaign-targeting-{{ app_key }} {% endfor %}"
                    id="{{adgroup.key}}">
                    <th class="campaignData-icon">
                      <input type="checkbox" name="id" value="{{adgroup.key}}"/>
                      {% if adgroup.deleted %}<img src="/images/deleted.gif" height=9 width=9 />{% endif %}
                      {% if adgroup.active and not adgroup.deleted %}<img src="/images/active.gif" height=9 width=9 />{% endif %}
                      {% if not adgroup.active and not adgroup.deleted %}<img src="/images/paused.gif" height=9 width=9 />{% endif %}
                    </th> 
                    <th class="dataTable-name">
                        <a href="{% url advertiser_adgroup_show adgroup_key=adgroup.key %}">{{adgroup.name}}</a><br/>
                        <span class="muted">
                            {% if adgroup.campaign.start_date and adgroup.campaign.end_date %}
                            {{adgroup.campaign.start_date|format_date_compact}}-{{adgroup.campaign.end_date|format_date_compact}}.
                            {% endif %} {% if adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                            Starts {{adgroup.campaign.start_date|format_date_compact}}.
                            {% endif %} {% if not adgroup.campaign.start_date and adgroup.campaign.end_date %}
                            Ends {{adgroup.campaign.start_date|format_date_compact}}.
                            {% endif %} {% if not adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                            All dates.
                            {% endif %}
                            {% if adgroup.campaign.budget %}{{adgroup.campaign.budget|currency}} daily budget.{% else %}Unlimited budget.{% endif %}
                        </span>
                    </th>
                    <td class="dataTable-data numeric dataTable-ecpm">
                        {% if adgroup.bid_strategy == 'cpm' %}
                        --
                        {% endif %}
                        {% if adgroup.bid_strategy == 'cpc' %}
                        <span class="dataTable-campaign-ecpm ecpm">
                          --
                          <a href="#" id="campaign-ecpm-helpLink" class="whatsthis">
                            <div class="whatsthis-icon"></div>
                          </a>
                        </span>  
                        {% endif %}
                    </td>    
                    <td class="dataTable-data numeric">Loading...</td>
                    <td class="dataTable-data numeric promo-imp imp">--</td>
                    <td class="dataTable-data numeric promo-clk clk">--</td>
                    <td class="dataTable-data numeric promo-ctr ctr">--</td>
                    <td class="dataTable-data numeric promo-conv conv">--</td>
                    <td class="dataTable-data numeric promo-cpa cpa">--</td>
                  </tr>
                  {% endfor %}
                  <tr class="campaignData campaignData-placeholder promo-placeholder">
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name"><span class="muted">None</span></th>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                  </tr>
                </tbody>
              </table>
              <h2>Network</h2>
              <div id='network-rollups' class="campaignData-rollup">
                  <table width=100% style='text-align:center; font-size:18px; font-weight:400;'>
                      <thead>
                          <tr>
                              <th width=25%>Impressions</th>
                              <th width=25%>Clicks</th>
                              <th width=25%>CTR</th>
                              <th width=25%>Fill Rate (Attempts)</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td id='network-total-imp'></td>
                              <td id='network-total-clk'></td>
                              <td id='network-total-ctr'></td>
                              <td id='network-total-fill'></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              <table class="dataTable campaignData-main">
                <thead>
                  <tr>
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name">Name</th>
                    <th class="dataTable-data numeric">eCPM</th>
                    <th class="dataTable-data numeric">Attempts</th>
                    <th class="dataTable-data numeric">Impressions</th>
                    <th class="dataTable-data numeric">Fillrate</th>
                    <th class="dataTable-data numeric">Clicks</th>
                    <th class="dataTable-data numeric">CTR</th>
                    <th class="dataTable-data numeric">&nbsp;</th>
                  </tr>
                </thead>
                <tbody>
                  {% for adgroup in network %}
                  <tr class="campaignData network_row campaign-status-all campaign-targeting-all
                    {% for app_key in adgroup.targeted_app_keys %} campaign-targeting-{{ app_key }} {% endfor %}"
                    
                   id="{{adgroup.key}}">

                    <th class="campaignData-icon">
                      <input type="checkbox" name="id" value="{{adgroup.key}}"/>
                      {% if adgroup.deleted %}<img src="/images/deleted.gif" height=9 width=9 />{% endif %}
                      {% if adgroup.active and not adgroup.deleted %}<img src="/images/active.gif" height=9 width=9 />{% endif %}
                      {% if not adgroup.active and not adgroup.deleted %}<img src="/images/paused.gif" height=9 width=9 />{% endif %}
                    </th> 
                    <th class="dataTable-name">
                      <a href="{% url advertiser_adgroup_show adgroup_key=adgroup.key %}">{{adgroup.name}}</a><br/>

                      <span class="muted">{{adgroup.network_type}}</span>
                    </th>
                    {% if adgroup.cpc %}
                    <td class="dataTable-data numeric dataTable-ecpm">
                        <span class="dataTable-campaign-ecpm ecpm">
                          --
                          <a href="#" id="campaign-ecpm-helpLink" class="whatsthis">
                            <div class="whatsthis-icon"></div>
                          </a>
                        </span>
                    </td>
                    {% else %}
                    <td class="dataTable-data numeric dataTable-ecpm ecpm">--</td>
                    {% endif %}
                    <td class="dataTable-data numeric network-req req">--</td>
                    <td class="dataTable-data numeric network-imp imp">--</td>
                    <td class="dataTable-data numeric network-fill fill">--</td>
                    <td class="dataTable-data numeric network-clk clk">--</td>
                    <td class="dataTable-data numeric network-ctr ctr">--</td>
                    <td class="dataTable-data numeric">&nbsp;</td>
                  </tr>
                  {% endfor %}
                  <tr class="campaignData campaignData-placeholder network-placeholder">
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name"><span class="muted">None</span></th>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                  </tr>
                </tbody>
              </table>
              <h2>Backfill Promotional</h2>
              <div id='bfill-rollups' class="campaignData-rollup">
                  <table width=100% style='text-align:center; font-size:18px; font-weight:400;'>
                      <thead>
                          <tr>
                              <th width=25%>Impressions</th>
                              <th width=25%>Clicks</th>
                              <th width=25%>CTR</th>
                              <th width=25%>Conversions</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td id='bfill-total-imp'></td>
                              <td id='bfill-total-clk'></td>
                              <td id='bfill-total-ctr'></td>
                              <td id='bfill-total-conv'></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              <table class="dataTable campaignData-main">
                <thead>
                  <tr>
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name">Name</th>
                    <th class="dataTable-data numeric">eCPM</th>
                    <th class="dataTable-data numeric">Status</th>
                    <th class="dataTable-data numeric">Impressions</th>
                    <th class="dataTable-data numeric">Clicks</th>
                    <th class="dataTable-data numeric">CTR</th>
                    <th class="dataTable-data numeric">Conv</th>
                    <th class="dataTable-data numeric">CPA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for adgroup in backfill_promo %}
                  <tr class="campaignData bfill_row campaign-status-all campaign-targeting-all
                    {% for app_key in adgroup.targeted_app_keys %} campaign-targeting-{{ app_key }} {% endfor %}" 
                    id="{{adgroup.key}}">
                    <th class="campaignData-icon">
                      <input type="checkbox" name="id" value="{{adgroup.key}}"/>
                      {% if adgroup.deleted %}<img src="/images/deleted.gif" height=9 width=9></img>{% endif %}
                      {% if adgroup.active and not adgroup.deleted %}<img src="/images/active.gif" height=9 width=9 />{% endif %}
                      {% if not adgroup.active and not adgroup.deleted %}<img src="/images/paused.gif" height=9 width=9 />{% endif %}
                    </th> 
                    <th class="dataTable-name">
                        <a href="{% url advertiser_adgroup_show adgroup_key=adgroup.key %}">{{adgroup.name}}</a><br/>
                        <span class="muted">
                            {% if adgroup.campaign.start_date and adgroup.campaign.end_date %}
                            {{adgroup.campaign.start_date|format_date_compact}}-{{adgroup.campaign.end_date|format_date_compact}}.
                            {% endif %} {% if adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                            Starts {{adgroup.campaign.start_date|format_date_compact}}.
                            {% endif %} {% if not adgroup.campaign.start_date and adgroup.campaign.end_date %}
                            Ends {{adgroup.campaign.start_date|format_date_compact}}.
                            {% endif %} {% if not adgroup.campaign.start_date and not adgroup.campaign.end_date %}
                            All dates.
                            {% endif %}
                            {% if adgroup.campaign.budget %}{{adgroup.campaign.budget|currency}} daily budget.{% else %}Unlimited budget.{% endif %}
                        </span>
                    </th>
                    {% if adgroup.cpc %}
                    <td class="dataTable-data numeric dataTable-ecpm">
                        <span class="dataTable-campaign-ecpm ecpm">
                          --
                          <a href="#" id="campaign-ecpm-helpLink" class="whatsthis">
                            <div class="whatsthis-icon"></div>
                          </a>
                        </span>
                    </td>
                    {% else %}
                    <td class="dataTable-data numeric dataTable-ecpm ecpm">--</td>
                    {% endif %}
                        
                    <td class="dataTable-data numeric status">Loading...</td>
                    <td class="dataTable-data numeric bfill-imp imp">--</td>
                    <td class="dataTable-data numeric bfill-clk clk">--</td>
                    <td class="dataTable-data numeric bfill-ctr ctr">--</td>
                    <td class="dataTable-data numeric bfill-conv conv">--</td>
                    <td class="dataTable-data numeric bfill-cpa cpa">--</td>
                  </tr>
                  {% endfor %}
                  <tr class="campaignData campaignData-placeholder bfill-placeholder">
                    <th class="campaignData-icon"></th>
                    <th class="dataTable-name"><span class="muted">None</span></th>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                    <td class="dataTable-data numeric"></td>
                  </tr>
                </tbody>
              </table>
              
              <div class="form-submit-left"> 
                <span class="buttonWrap"><a class="button" id="campaignForm-pause">Pause</a>
                <a class="button" id="campaignForm-resume">Resume</a>
              </div> 
            </form> 
          </section>
          
          {# Help Content #}
          <div id="campaign-ecpm-helpContent" class="hidden"> 
            <h3>Revenue Optimized Campaign eCPM</h3>
            <p>We calculate the <strong>eCPM</strong> for CPC campaigns by combining the CPC of the campaign with our CTR calculated in real time. </p>
            <p> This number may vary over time. This is perfectly natural and our system will adjust to these fluctuations in real time. </p>
            <p> Campaigns that have not yet begun use the average CTR of the entire app to calculate eCPM. </p>        
          </div>
          
{% endblock content %}
