var mopub=mopub||{};(function(g,l){var b=l.Model.extend({defaults:{active:false,attempts:0,clicks:0,ctr:0,ecpm:0,fill_rate:0,impressions:0,name:"",price_floor:0,revenue:0},validate:function(o){var p=Number(o.price_floor);if(p==NaN){return"please enter a valid number for the price floor"}},url:function(){return"/api/app/"+this.app_id+"/adunits/"+this.id+"?"+window.location.search.substring(1)}});var a=l.Collection.extend({model:b,url:function(){return"/api/app/"+this.app_id+"/adunits/?"+window.location.search.substring(1)}});var c=l.Model.extend({defaults:{name:"",url:"#",revenue:0,attempts:0,icon_url:"/placeholders/image.gif",impressions:0,fill_rate:0,clicks:0,price_floor:0,app_type:"iOS",ecpm:0,ctr:0},url:function(){return"/api/app/"+this.id+"?"+window.location.search.substring(1)},parse:function(o){return o[0]}});var m=l.Collection.extend({model:c,url:"/api/app/",fetchAdUnits:function(){this.each(function(o){o.adunits=new a();o.adunits.app_id=o.id;o.adunits.fetch()})}});var e=l.Model.extend({defaults:{revenue:0,ecpm:0,impressions:0,clicks:0,ctr:0,creative_url:"#",ad_domain:"#",domain_blocked:false},url:function(){return"/api/creative/"+this.id+"?"+window.location.search.substring(1)}});var k=l.Collection.extend({model:e,url:function(){return"/api/dsp/"+this.dsp_key+"?"+window.location.search.substring(1)}});var n=l.View.extend({initialize:function(){this.template=_.template(g("#app-template").html())},renderInline:function(){var o=g("tr.app-row#app-"+this.model.id,this.el);g(".revenue",o).text(this.model.get("revenue"));g(".impressions",o).text(this.model.get("impressions"));g(".ecpm",o).text(this.model.get("ecpm"));return this},render:function(){var o=g(this.template(this.model.toJSON()));g("a.adunits",o).click(j);g("tbody",this.el).append(o);return this}});var h=l.View.extend({initialize:function(){this.template=_.template(g("#creative-row-template").html())},render:function(){var o=g(this.template(this.model.toJSON()));g("tbody",this.el).append(o);return this}});function j(p){p.preventDefault();var o=g(this).attr("href").replace("#","");f.fetchAdunitsForApp(o);g(this).text("Hide AdUnits").unbind("click").click(d)}function d(p){p.preventDefault();var o=g(this).attr("href").replace("#","");g.each(g(".for-app-"+o),function(q,r){g(r).remove()});g("#app-"+o+" a.view_targeting").removeClass("hidden");g(this).text("Show Adunits").unbind("click").click(j)}var i=l.View.extend({initialize:function(){this.template=_.template(g("#adunit-template").html())},renderInline:function(){var p=this.model;var o=g("tr.adunit-row#adunit-"+this.model.id,this.el);g(".revenue",o).text(this.model.get("revenue"));g(".ecpm",o).text(this.model.get("ecpm"));g(".impressions",o).text(this.model.get("impressions"));g(".price_floor",o).html('<input id="'+this.model.id+'" type="text" class="input-text input-text-number number" style="width:50px;" value="'+this.model.get("price_floor")+'"> <img class="loading-img hidden"  src="/images/icons-custom/spinner-12.gif"></img>');g(".targeting",o).html('<input class="targeting-box" type="checkbox"> <img class="loading-img hidden"  src="/images/icons-custom/spinner-12.gif"></img>');if(this.model.get("active")){g("input.targeting-box",o).attr("checked","checked")}g("input.targeting-box",o).click(function(){var q=g(".targeting .loading-img",o);q.show();p.set({active:g(this).is(":checked")});p.save({},{success:function(){setTimeout(function(){q.hide()},2000)}})});g(".price_floor .input-text",o).keyup(function(){var q=g(".price_floor .loading-img",o);q.show();p.set({price_floor:g(this).val()});p.save({},{success:function(){setTimeout(function(){q.hide()},2000)}})});return this},render:function(){var r=this.model;var p=g(this.template(this.model.toJSON()));g(".price_floor_change",p).change(function(){r.set({price_floor:g(this).val()});var s=g(".save",g(this).parent());s.click(function(t){t.preventDefault();s.addClass("disabled").text("Saving...");r.save({},{success:function(){setTimeout(function(){s.removeClass("disabled").text("Saved");s.text("Save")},2000)}})})});g("input.targeting-box",p).click(function(){var s=g(this).attr("name");var t=g(this).is(":checked")?"On":"Off";g("label[for='"+s+"']",p).text(t);r.set({active:g(this).is(":checked")});r.save()});var q=g("tr#app-"+this.model.get("app_id"),this.el);var o=q.hasClass("even")?"even":"odd";p.addClass(o);q.after(p);return this}});var f={fetchAllApps:function(o){_.each(o,function(p){var q=new c({id:p});q.bind("change",function(r){var s=new n({model:r,el:"#marketplace_stats"});s.render()});q.fetch({success:function(){g("table").trigger("update")}})})},fetchAppStats:function(o){_.each(o,function(p){var q=new c({id:p});q.bind("change",function(r){var s=new n({model:r,el:"#marketplace_stats"});s.renderInline()});q.fetch()})},fetchAdunitStats:function(p){var o=new a();o.app_id=p;o.bind("reset",function(q){_.each(q.models,function(r){var s=new i({model:r,el:"#marketplace_stats"});s.renderInline()})});o.fetch({success:function(){g("table").trigger("update");g("#"+p+"-img").hide()}})},fetchAdunitsForApp:function(p){var o=new a();o.app_id=p;o.bind("reset",function(r){var t=_.max(r.models,function(u){return u.get("price_floor")}).get("price_floor");var q=_.min(r.models,function(u){return u.get("price_floor")}).get("price_floor");var s=g("<a href='#"+p+"' class='edit_price_floor' id='"+p+"'> Edit Price Floor</a>");if(t==q){g(".app-row#app-"+p+" .price_floor").html("All $"+t)}else{g(".app-row#app-"+p+" .price_floor").html("$"+q+" - $"+t)}g(".app-row#app-"+p+" .view_targeting").addClass("hidden");_.each(r.models,function(u){var v=new i({model:u,el:"#marketplace_stats"});v.render()})});o.fetch()},getAppId:function(p){p=g(p);var o="";var q=p.attr("class").split(" ");_.each(q,function(r){if(r.search("for-app-")>=0){o=r.replace("for-app-","")}});return o},fetchAllCreatives:function(o){_.each(o,function(q){var p=new k();p.dsp_key=q;p.bind("reset",function(r){_.each(r.models,function(s){var t=new h({model:s,el:"table#creatives"});t.render()})});p.fetch({success:function(){g("table#creatives").trigger("update")}})})},turnOn:function(){g.ajax({type:"post",url:"/campaigns/marketplace/activation/",data:{activate:"on"},});return true},turnOff:function(){g.ajax({type:"post",url:"/campaigns/marketplace/activation/",data:{activate:"off"}});return true},makeCreativePerformanceTable:function(o,q,r){var p=g("#report-table").dataTable({bProcessing:true,bJQueryUI:true,sPaginationType:"full_numbers",oLanguage:{sEmptyTable:"No creatives have been displayed for this time range."},aoColumns:[{sWidth:"330px"},{sWidth:"190px"},{sWidth:"120px"},{sWidth:"90px"},{sWidth:"90px"}],bAutoWidth:false,aaSorting:[[2,"desc"]],sAjaxSource:"http://mpx.mopub.com/stats/creatives",fnServerData:function(t,s,u){g.ajax({url:t,data:{pub_id:o,start:"10-24-2011",end:"10-27-2011",format:"jsonp"},success:function(x,z,w){var y=_.map(x,function(A,B){var C=(A.stats["pub_rev"]/(A.stats["imp"]+1))*1000;return[A.creative["url"],A.creative["ad_dmn"],A.stats["pub_rev"],C,A.stats["imp"]]});var v={aaData:y};u(v,z,w)},dataType:"jsonp",cache:false})},fnRowCallback:function(u,t,s){g("td:eq(0)",u).html("<iframe width='320px' height='50px' src='"+t[0]+"'></iframe>");var v=t[1];if(_.contains(r,v)){g("td:eq(1)",u).text(v+" (Blocked)")}else{if(v!=null){g("td:eq(1)",u).html(v)}else{g("td:eq(1)",u).html("<span class='muted'>(Unknown)</span>")}}g("td:eq(2)",u).addClass("numeric").text(mopub.Utils.formatCurrency(t[2]));g("td:eq(3)",u).addClass("numeric").text(mopub.Utils.formatCurrency(t[3]));g("td:eq(4)",u).addClass("numeric").text(mopub.Utils.formatNumberWithCommas(t[4]));return u}});return p}};window.AdUnit=b;window.AdUnitCollection=a;window.App=c;window.AppCollection=m;window.AdUnitView=i;window.AppView=n;window.Marketplace=f;g(document).ready(function(){g.tablesorter.addWidget({id:"adunitSorting",format:function(r){var q={};g(".adunit-row",r).each(function(s,u){var t=f.getAppId(u);var v;if(q.hasOwnProperty(t)){v=q(t)}else{v=g(".app-row#app-"+t)}g(u).remove();v.after(u)})}});g("#marketplace_stats").tablesorter({widgets:["adunitSorting"],sortList:[[1,0]],headers:{0:{sorter:false},6:{sorter:false},7:{sorter:false}}});g("a.block").click(function(r){r.preventDefault();var q=g(this);var s=g(this).attr("id");g.ajax({type:"post",url:"/campaigns/marketplace/addblocklist",data:{blocklist:s},success:function(u,t){q.text("Blocked").unbind("click").click(function(){return false})}})});g(".lightswitch").lightswitch(f.turnOn,f.turnOff);g("#top_switch").click(function(){if(g("#top_switch .switch").hasClass("on")){g("#first_time_toast").fadeIn();setTimeout(function(){g("#first_time_toast").fadeOut()},3000)}});g("#bottom_switch").click(function(){if(g("#bottom_switch .switch").hasClass("off")){g("#settings_toast").fadeIn();setTimeout(function(){g("#settings_toast").fadeOut()},3000)}});g("#blocklist-submit").click(function(q){q.preventDefault();g("#addblocklist").submit()});function o(){var q=g("#dashboard-stats .stats-breakdown .active");if(q.attr("id")=="stats-breakdown-ecpm"){return"line"}else{return"area"}}g(".stats-breakdown tr").click(function(q){g("#dashboard-stats-chart").fadeOut(100,function(){mopub.Chart.setupDashboardStatsChart(o());g(this).show()})});var p=mopub.accountStats.daily;mopub.dashboardStatsChartData={pointStart:mopub.graphStartDate,pointInterval:86400000,revenue:[{Total:mopub.Stats.statArrayFromDailyStats(p,"revenue_float")}],impressions:[{Total:mopub.Stats.statArrayFromDailyStats(p,"impressions")}],ecpm:[{Total:mopub.Stats.statArrayFromDailyStats(p,"ecpm_float")}]};mopub.Chart.setupDashboardStatsChart(o());g("#dashboard-dateOptions input").click(function(){var r=g(this).val();var s=document.location.hash;if(r=="custom"){g("#dashboard-dateOptions-custom-modal").dialog({width:570,buttons:[{text:"Set dates",css:{fontWeight:"600"},click:function(){var y=g("#dashboard-dateOptions-custom-from").datepicker("getDate");var u=g("#dashboard-dateOptions-custom-to").datepicker("getDate");var w=Math.ceil((u.getTime()-y.getTime())/(86400000))+1;var x=y.getDate();var t=y.getMonth()+1;var z=y.getFullYear();g(this).dialog("close");var v=document.location.href.replace(s,"").replace(/\?.*/,"");document.location.href=v+"?r="+w+"&s="+z+"-"+t+"-"+x+s}},{text:"Cancel",click:function(){g(this).dialog("close")}}]})}else{var q=document.location.href.replace(s,"").replace(/\?.*/,"");document.location.href=q+"?r="+r+s}});g("#stats-breakdown-dateOptions input").click(function(){g(".stats-breakdown-value").hide();g(".stats-breakdown-value."+g(this).val()).show()});g("#dashboard-dateOptions-custom-from").datepicker({defaultDate:"-15d",maxDate:"0d",onSelect:function(t){var r=g("#dashboard-dateOptions-custom-to");var q=g(this).data("datepicker");var s=g.datepicker.parseDate(q.settings.dateFormat||g.datepicker._defaults.dateFormat,t,q.settings);r.datepicker("option","minDate",s)}});g("#dashboard-dateOptions-custom-to").datepicker({defaultDate:"-1d",maxDate:"0d",onSelect:function(t){var r=g("#dashboard-dateOptions-custom-from");var q=g(this).data("datepicker");var s=g.datepicker.parseDate(q.settings.dateFormat||g.datepicker._defaults.dateFormat,t,q.settings);r.datepicker("option","maxDate",s)}})})})(this.jQuery,this.Backbone);