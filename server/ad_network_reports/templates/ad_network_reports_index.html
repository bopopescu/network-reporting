{% extends "ad_network_base.html" %}
{% load filters %}

{% block adNetworkTitle %}
{% endblock %}

{% block titleBarRight %}
<span class="titlebar-link">
  <a class="linkIcon" href="/campaigns/networks/">Back to Networks  <span class="ui-icon ui-icon-triangle-1-e"></span></a>
</span>
{% endblock titleBarRight %}

{% block innerContent %}

  <ul class="pills">
    <li class="active"> <a href="#networks"> Sort by Network </a> </li>
    <li> <a href="#apps"> Sort by App </a> </li>
  </ul>

  {% comment %}
    Make the table sorted by ad network.
  {% endcomment %}
  <div class="tab-section active" id="networks">
    <table class="dataTable ad_network_table">
      <thead>
        <th class="dataTable-name" colspan="2"></th>
        <th class="dataTable-data numeric"> Revenue </th>
        <th class="dataTable-data numeric"> Attempts </th>
        <th class="dataTable-data numeric"> Impressions </th>
        <th class="dataTable-data numeric"> Fill Rate</th>
        <th class="dataTable-data numeric"> Clicks </th>
        <th class="dataTable-data numeric"> CTR </th>
      </thead>

      <tbody>
        {% for network_name, network, form in networks %}
          <tr class="top-row">
            <td class="appData-icon">
              <img src="/images/{{network_name|lower}}-transparent.png"
              alt="{{network_name}}" width="75" height="25" />
            </td>
			{% if network %}
						<td class="dataTable-name">
							<span class="muted">Last synced: {{ network.sync_date|date }}</span>
							<div>
								<a class="show-hide button button-small" id={{network.key}}>Hide Apps</a>
								<a class="button button-small">Status</a>
				  		</div>
				  	</td>
						<td class="dataTable-data numeric">{{ network.revenue|currency }} </td>
						<td class="dataTable-data numeric">{{ network.attempts|withsep }} </td>
						<td class="dataTable-data numeric">{{ network.impressions|withsep }} </td>
						<td class="dataTable-data numeric">{{ network.fill_rate|floatformat:2 }}% </td>
						<td class="dataTable-data numeric">{{ network.clicks|withsep }} </td>
						<td class="dataTable-data numeric">{{ network.ctr|floatformat:2 }}% </td>
				{% else %}
						<td class="dataTable-name" colspan="7">
							<div>
                                <a class="show-status button button-small" id="{{network_name}}-status">Enable Reporting</a>
				  		</div>
				  	</td>
				{% endif %}
          </tr>
          <tr class="{{network_name}}-status hidden">
              <td class="dataTable-name" colspan="8">
                  <div>
                      {% if network %}
                      <dl class="formFields" style="margin:0">
                          {% if network.sync_error %}
                          <dt>Status:</dt>
                          <dd>Last synchronization failed.  Check that your credentials are correct.
                          If this error persists, please contact support@mopub.com.</dd>
                          {% endif %}
                          <dt>Notes:</dt>
                          <dd> MoPub received a response for the following ad networks IDs.
                          Make sure these apps are properly set up in MoPub to view the reports.
                          <br/><br/>
                          abcdefg, abcdefg, abcdefg
                          </dd>
                      </dl>
                      {% endif %}
                      <form id="loginCredentials">
                          <fieldset>
                              <h2>{{network_name}} Credentials</h2>
                              <dl class="formFields" style="margin:0">
                                  <dt>Username:</dt>
                                  <dd><input type="text" class="input-text"></dd>
                                  <dt>Password:</dt>
                                  <dd><input type="text" class="input-text"></dd>
                                  <dt><input name="email" type="checkbox" /> </dt>
                                  <dd> Send me daily emails with my network stats </dd>
                                  <dt></dt>
                                  <dd>
                                  <a class="button">Update</a>
                                  <a class="show-status button" id="{{network_name}}-status">Cancel</a>
                                  </dd>
                              </dl>
                          </fieldset>
                      </form>
                  </div>
              </td>
          </tr>
		  {% if network %}
          {% for app in network.sub_data_list %}
          <tr class="sub-rows {% if not forloop.last %} add-border {% endif %} for-key-{{network.key}}">
              <td class="dataTable-name" colspan="2">
                <a href="{% url ad_network_app_detail app.key %}">{{app.name}}</a>
              </td>
              <td class="dataTable-data numeric">{{ app.revenue|currency }}</td>
              <td class="dataTable-data numeric">{{ app.attempts|withsep }}</td>
              <td class="dataTable-data numeric">{{ app.impressions|withsep }}</td>
              <td class="dataTable-data numeric">{{ app.fill_rate|floatformat:2 }}%</td>
              <td class="dataTable-data numeric">{{ app.clicks|withsep }}</td>
              <td class="dataTable-data numeric">{{ app.ctr|floatformat:2 }}%</td>
            </tr>
          {% endfor %}
		  {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>


  {% comment %}
    Make the table sorted by app name. This table is hidden to start.
  {% endcomment %}
  <div class="tab-section" id="apps">
    <table class="simpletable campaignData-main ad_network_table">
      <thead>
        <th class="dataTable-name"></th>
        <th class="dataTable-data numeric"> Revenue </th>
        <th class="dataTable-data numeric"> Attempts </th>
        <th class="dataTable-data numeric"> Impressions </th>
        <th class="dataTable-data numeric"> Fill Rate </th>
        <th class="dataTable-data numeric"> Clicks </th>
        <th class="dataTable-data numeric"> CTR </th>
      </thead>

      <tbody>
        {% for app_name, app in apps %}
        <div class="section">
          <tr class="top-row" id="{{app.key}}">
            <td class="dataTable-name" colspan="2"> {{app_name}} </td>
            <td class="dataTable-data numeric">{{ app.revenue|currency }}</td>
            <td class="dataTable-data numeric">{{ app.attempts|withsep }}</td>
            <td class="dataTable-data numeric">{{ app.impressions|withsep }}</td>
            <td class="dataTable-data numeric">{{ app.fill_rate|floatformat:2 }}%</td>
            <td class="dataTable-data numeric">{{ app.clicks|withsep }}</td>
            <td class="dataTable-data numeric">{{ app.ctr|floatformat:2 }}%</td>
          </tr>
          {% for network in app.sub_data_list %}
          <tr class="sub-rows {% if not forloop.last %} add-border {% endif %} for-key-{{app.key}}">
              <td class="dataTable-name">
                 <a href="{% url ad_network_app_detail network.key %}">{{network.name}} </a>
                 {% if network.has_potential_errors %}
                   <br />
                   (Couldn't collect stats. <a href="{% url ad_network_settings %}">Check the publisher id you entered for this network</a>.)
                 {% endif %}
              </td>
              <td class="dataTable-data numeric">{{ network.revenue|currency }}</td>
              <td class="dataTable-data numeric">{{ network.attempts|withsep }}</td>
              <td class="dataTable-data numeric">{{ network.impressions|withsep }}</td>
              <td class="dataTable-data numeric">{{ network.fill_rate|floatformat:2 }}%</td>
              <td class="dataTable-data numeric">{{ network.clicks|withsep }}</td>
              <td class="dataTable-data numeric">{{ network.ctr|floatformat:2 }}%</td>
            </tr>
          {% endfor %}
        </div>
        {% endfor %}
      </tbody>
    </table>
  </div>


  {% if networks_without_creds %}
    <div class="alert-message block-message warning">
      You've entered publisher information for the following ad networks,
      but we can't generate stats for you until you've entered your login
      credentials for the ad network.
      <br />
      <ul>
      {% for network in networks_without_creds %}
        <li> <strong>{{ network}}</strong>  (<a class="addcreds" href="#{{network}}"> Add Login Credentials </a>) </li>
      {% endfor %}
      </ul>
  </div>
  {% endif %}
  <a class="right button" href="/ad_network_reports/add">Add / Change network credentials</a>


  {% comment %}
  <div class="tab-section" id="networks">
    <table class="zebra-striped simpletable campaignData-main sortable">
      <thead>
        <th class="dataTable-name"> App </th>
        <th class="dataTable-name"> Ad Network </th>
        <th class="dataTable-data numeric"> Revenue </th>
        <th class="dataTable-data numeric"> Attempts </th>
        <th class="dataTable-data numeric"> Impressions </th>
        <th class="dataTable-data numeric"> Fill Rate</th>
        <th class="dataTable-data numeric"> Clicks </th>
        <th class="dataTable-data numeric"> CTR </th>
      </thead>

      <tbody>
        {% for key, mapper, stats in aggregate_stats_list %}
          <tr>
            <td class="dataTable-name"><a href='/ad_network_reports/app_view/{{key}}'>{{mapper.application.name}}</a></td>
            <td class="dataTable-name">{{mapper.ad_network_name}}</td>
            <td class="dataTable-data numeric">{{ stats.revenue|currency }}</td>
            <td class="dataTable-data numeric">{{stats.attempts|withsep }}</td>
            <td class="dataTable-data numeric">{{stats.impressions|withsep }}</td>
            <td class="dataTable-data numeric">{{stats.fill_rate|percentage }}</td>
            <td class="dataTable-data numeric">{{stats.clicks|withsep }}</td>
            <td class="dataTable-data numeric">{{stats.ctr|percentage }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% endcomment %}

{% endblock innerContent %}



{% block appendedContent %}

  <div class="hidden" id="credential-form">
    <form id="loginCredentials">
      <div id="error"> {{error}} </div>
      <dl class="formFields clearfix" style="width: 350px;">
        <div class="hidden">
        <dt> Ad Network </dt>
        <dd>
          <select name="ad_network_name" id="ad_network_selector">
            {% for network in ad_network_names %}
              <option value="{{network}}"> {{network}} </option>
            {% endfor %}
          </select>
        </dd>
        </div>

          {% for form in forms %}

            <div id="{{form.ad_network}}-fields" class="network_form">

              {% ifequal form.ad_network "inmobi" %}
                <dt> InMobi Access ID </dt>
                <dd>
                  <input type="text" name="{{form.ad_network}}-username" id="id_username" class=" input-text" value=""> {{form.username.errors}}
                  <a href="#" class="whatsthis" id="inmobi-access-helpLink"> What's This? </a>
                </dd>

                <dt> InMobi Secret Key </dt>
                <dd>
                  <input type="password" name="{{form.ad_network}}-password"  id="id_password" class=" input-text" value="">  {{form.password.errors}}
                  <a href="#" class="whatsthis" id="inmobi-secret-helpLink"> What's This? </a>
                </dd>

              {% else %}
                <dt> Username </dt>
                <dd> <input type="text" name="{{form.ad_network}}-username" id="id_username" class=" input-text" value=""> {{form.username.errors}}</dd>

                <dt> Password</dt>
                <dd> <input type="password" name="{{form.ad_network}}-password"  id="id_password" class=" input-text" value="">  {{form.password.errors}}</dd>
              {% endifequal %}


          {% if form.ad_network == "admob" %}
            <dt> Client ID </dt>
            <dd> {{form.client_key}} </dd>
          {% endif %}


          <dt><input name="email" type="checkbox" /> </dt>
          <dd> Send me daily emails with my network stats </dd>

        </div>
      {% endfor %}

      <input class="right button" type="submit" value="Submit" />

  </div>

{% endblock appendedContent %}


{% block extraScripts %}
  {{ block.super }}
  <script type="text/javascript" src="/js/mopub-advertiser.js?v=46"></script>
  <script>
    $(function () {
        mopub.Advertiser.initializeAdReportsIndex();
        mopub.Advertiser.initializeCredentialsPage();
    });
  </script>
{% endblock extraScripts %}
