{% extends "ad_network_base.html" %}
{% load filters %}

{% block adNetworkTitle %}
{% endblock %}

{% block pageTitle %}
  <div class="breadcrumb">
    <a class="linkIcon breadcrumb-back" href="/campaigns/networks/"><span class="ui-icon ui-icon-arrowthick-1-w"></span> Back to Networks</a>
    <h1>Ad Network Revenue Report</h1>
  </div>
{% endblock pageTitle %}

{% block innerContent %}
  <section id="dashboard-apps">
  <span class="buttonset" id="dashboard-sort">
    <input type="radio" name="dashboard-sort-option" value="networks" checked="checked" id="dashboard-sort-network"/>
    <label for="dashboard-sort-network">Sort by Network</label>
    <input type="radio" name="dashboard-sort-option" value="apps" id="dashboard-sort-app"/>
    <label for="dashboard-sort-app">Sort by App</label>
  </span>
  <div class="buttonBank buttonBank-right">
      <select name='exportSelect' id='ad-network-exportSelect' class='selectmenu'>
          <option value="">Export</option>
          <option value="/ad_network_reports/export/xls">XLS</option>
          <option value="/ad_network_reports/export/csv">CSV</option>
      </select>
  </div>

  {% comment %}
    Make the table sorted by ad network.
  {% endcomment %}
  <div class="tab-section networks active">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Revenue </th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate </th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for network, network_data in networks %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr>
            <td class="networkData-icon">
              <img src="/images/{{network}}-transparent.png"
              alt="{{network_data.pretty_name}}" width="75" height="25" />
            </td>
            {% if network_data.state != LoginStates.NOT_SETUP %}
            <td class="network-status dataTable-name">

                {% if network_data.state == LoginStates.WORKING %}
                <span class="muted">Last synced: {{ network.sync_date|date }}</span>
                {% endif %}
                <a class="show-status" style="cursor:pointer;" id="{{network}}-status">Status</a>
                {% if network_data.state == LoginStates.WORKING %}
                <div>
                    <a class="show-hide button button-small" id="{{network}}" style="width:75px;">Show Apps</a>
                </div>
                {% endif %}
            </td>
            {% endif %}
            {% if network_data.state == LoginStates.WORKING %}
              <td class="dataTable-data numeric {{network}}-revenue">--</td>
              <td class="dataTable-data numeric {{network}}-attempts">--</td>
              <td class="dataTable-data numeric {{network}}-impressions">--</td>
              <td class="dataTable-data numeric {{network}}-cpm">--</td>
              <td class="dataTable-data numeric {{network}}-fill-rate">--</td>
              <td class="dataTable-data numeric {{network}}-clicks">--</td>
              <td class="dataTable-data numeric {{network}}-cpc">--</td>
              <td class="dataTable-data numeric {{network}}-ctr">--</td>
            {% else %}
              {% if network_data.state == LoginStates.NOT_SETUP %}
              <td class="network-status dataTable-name" colspan="7">
                <div class="form-{{network}}-enable">
                 <a class="show-status button button-small" id="{{network}}-status">Enable Reporting</a>
                </div>
              </td>
              {% endif %}
            {% endif %}
          </tr>
        </tbody>
      </table>
      <div class="{{network}}-status hidden">
        <div class="form-{{network}}-message hidden alert-message block-message warning"></div>
        <dl class="formFields thin" style="margin:0">
          {% if network_data.state == LoginStates.ERROR %}
            <dt>Status:</dt>
            <dd>Last synchronization failed.  Check that your credentials are correct.
            If this error persists, please contact support@mopub.com.</dd>
          {% endif %}
          {% if network.apps_without_pub_ids or network.app_pub_ids %}
            <dt>Notes:</dt>
            <dd>
            {% if network_data.apps_without_pub_ids %}
              {% if network == IAD %}
                In order to pull revenue data for your apps, MoPub requires that your
                app names in MoPub match your app names in iAd and you assign an
                iTunes URL for each app. Click 'Edit app settings' for each app and
                enter your iTunes URL:
                <br/><br/>
                {% for app in network.apps_without_pub_ids %}<a href="/inventory/app/{{app.key}}">{{app.name}}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
            {% else %}
                In order to pull revenue data for your apps, MoPub requires that you
                assign your ad network ID for each app.  Set up your network ID on
                the <a href="/account/networks/">Ad Network Settings</a> page for the
                following apps:
                <br/><br/>
                {{network.apps_without_pub_ids}}
              {% endif %}
            {% else %}
              {% if network == IAD %}
                MoPub received a response for the following apps. Make sure these
                apps are properly set up in MoPub to view the reports (the MoPub
                app names exactly match the iAd app names and the iTunes URLs
                are properly enetered for the apps).
              {% else %}
                MoPub received a response for the following ad networks IDs.
                Make sure these apps are properly set up in MoPub to view the reports.
              {% endif %}
              <br/><br/>
              {{ network_data.app_pub_ids }}
            {% endif %}
            </dd>
          {% endif %}
        </dl>
        <form class="loginCredentials" id="form-{{network}}" autocomplete="off">
          <fieldset>
              <h2>{{network_data.pretty_name}} Credentials{% if network == "admob" or network == "inmobi" %} <a target="_blank" href="http://help.mopub.com/customer/portal/articles/{% ifequal network "admob" %}274115-admob-revenue-reporting-setup{% else %}274260-inmobi-revenue-reporting-setup{% endifequal %}">(Learn more)</a> {% endif %}</h2>
              <dl class="formFields thin" style="margin:0">
                  {% ifequal network "inmobi" %}
                    <dt class="wide"> Access ID: </dt>
                    <dd class="thinner">
                      <input type="text" name="{{network}}-username"
                      id="id_username" class="input-text input-text-half-width"
                      value=""> {{network_data.form.username.errors}}
                    </dd>

                    <dt class="wide"> Secret Key: </dt>
                    <dd class="thinner">
                      <input type="password" name="{{network}}-password"
                      id="id_password" class="input-text input-text-half-width"
                      value="">  {{network_data.form.password.errors}}
                    </dd>

                  {% else %}
                      {% ifequal network "mobfox" %}
                      {% else %}
                        <dt class="wide"> Username: </dt>
                        <dd class="thinner"> <input type="text" name="{{network}}-username" id="id_username" class="input-text input-text-half-width" value="{{network_data.form.initial.username}}"> {{network_data.form.username.errors}}</dd>

                        <dt class="wide">{% ifequal network "admob" %} API {% endifequal %}Password: </dt>
                        <dd class="thinner"> <input type="password" name="{{network}}-password"  id="id_password" class="input-text input-text-half-width" value="{{network_data.form.initial.password}}"> 
                        {{network_data.form.password.errors}}
                        </dd>
                      {% endifequal %}
                  {% endifequal %}


                  {% if network == "admob" %}
                    <dt class="wide"> API Key: </dt>
                    <dd class="thinner"> <input type="text" name="admob-client_key"
                    id="id_admob-client_key" class="input-text
                    input-text-half-width" value="{{network_data.form.initial.client_key}}"></dd>
                  {% endif %}

                  <dt>
                    <input name="email" type="checkbox" {% if network_data.form.initial.email %} checked="{{network_data.form.initial.email}}" {% endif %} />
                  </dt>
                  <dd> Send me daily emails with my network stats </dd>
              </dl>
          </fieldset>
        </form>
      </div>
      {% if network_data.state == LoginStates.WORKING %}
      <div class="appData-details hidden {{network}}-row" style="margin: -10px 0 0 86px">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody id="app-on-{{network}}">
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  {% endfor %}
  </div>

  {% comment %}
    Make the table sorted by app name. This table is hidden to start.
  {% endcomment %}
  <div class="tab-section apps">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Revenue </th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate</th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for app_name, app in apps %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr class="app-row" id="{{app.key}}">
            <td class="appData-icon"><a href="{% url publisher_app_show app_key=app.key %}"><img src="{% if app.icon_url %}{{app.icon_url}}{% else %}/placeholders/image.gif{% endif %}" alt="Icon" width="45" height="45" /></a></td>
            <td class="dataTable-name">
                <a href="{% url publisher_app_show app_key=app.key %}">{{app_name.0}}</a>
                <span class="muted unbold">({{app_name.1}})</span>
                <img id="{{app.key}}-img" class="loading-img" style="display:none;" src="../images/icons-custom/spinner-12.gif"></img>
            </td>
            <td class="dataTable-data numeric">{{app.revenue|currency}}</td>
            <td class="dataTable-data numeric">{{app.attempts|withsep}}</td>
            <td class="dataTable-data numeric">{{app.impressions|withsep}}</td>
            <td class="dataTable-data numeric">{{app.cpm|currency}}</td>
            <td class="dataTable-data numeric">{{app.fill_rate|percentage}}</td>
            <td class="dataTable-data numeric">{{app.clicks|withsep}}</td>
            <td class="dataTable-data numeric">{{app.cpc|currency}}</td>
            <td class="dataTable-data numeric">{{app.ctr|percentage}}</td>
          </tr>
        </tbody>
      </table>
      <div class="appData-details">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody>
              {% for network in app.sub_data_list %}
              <tr class="show-details" id="{{network.key}}">
                <td class="dataTable-name">
                   {{network.name}} <a class="hidden details-{{network.key}}" href="{% url ad_network_app_detail network.key %}">Details</a>
                </td>
                <td class="dataTable-data numeric">{{ network.revenue|currency }}</td>
                <td class="dataTable-data numeric">{% if network.name != MOBFOX %}{{ network.attempts|withsep }}{% endif %}</td>
                <td class="dataTable-data numeric">{{ network.impressions|withsep }}</td>
                <td class="dataTable-data numeric">{{ network.cpm|currency }}</td>
                <td class="dataTable-data numeric">{% if network.name != MOBFOX %}{{ network.fill_rate|percentage }}{% endif %}</td>
                <td class="dataTable-data numeric">{{ network.clicks|withsep }}</td>
                <td class="dataTable-data numeric">{{ network.cpc|currency }}</td>
                <td class="dataTable-data numeric">{{ network.ctr|percentage }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
  </section>

{% endblock innerContent %}

{% block extraScripts %}
  {{ block.super }}
  <script type="text/html" id="app-on-network-row-template">
    {% include "partials/app_on_network.html" %}
  </script>
  <script type="text/javascript" src="/js/models.js?v=1"></script>
  <script type="text/javascript" src="/js/views.js?v=1"></script>
  <script type="text/javascript" src="/js/controllers/advertiser.js?v=46"></script>
  <script type="text/javascript" src="/js/controllers/ad_network_reports.js?v=2"></script>
  <script>
    $(function () {
        mopub.Advertiser.initializeAdReportsIndex();
        account_key = '{{ account_key }}';
        mopub.Advertiser.initializeCredentialsPage(account_key);

        AdNetworkReportsController(
        [{% for network, network_data in networks %} {
           network: '{{ network }}',
           models: [{% for app in network_data.apps %}{
            id: '{{ app.id }}',
            network: '{{ network }}'},
          {% endfor %}]},
        {% endfor %}],
        's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}');
    });
  </script>
{% endblock extraScripts %}
