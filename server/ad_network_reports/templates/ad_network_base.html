{% extends 'common/base.html' %}
{% load filters %}
{% block navLinks %}
  <li><a href="{% url app_index %}">Dashboard</a></li>
  <li><a href="{% url advertiser_order_index %}">Orders</a></li>
  <li><a href="{% url marketplace_index %}">Marketplace</a></li>
  <li class="active"><a href="{% url network_index %}">Networks</a></li>
{% endblock navLinks %}

{% block pageTitle %}
  <div class="breadcrumb">
    <a class="linkIcon breadcrumb-back" href="/ad_network_reports/"><span class="ui-icon ui-icon-arrowthick-1-w"></span> Back to Ad Network Revenue Report</a>
    <h1>{{app_name}} on {{ad_network_name}}</h1>
  </div>
{% endblock pageTitle %}

{% block titleBarRight %}
{% endblock titleBarRight %}

{% block extraScripts %}
  <script type="text/javascript">
    var mopub = mopub || {};

    // Populate the graph with revenue, impressions and clicks stats
    function populateGraphWithStats(dailyStats) {
        mopub.dashboardStatsChartData = {
            pointStart: mopub.graphStartDate,
            pointInterval: 86400000,
            revenue: [{ "Total": mopub.Stats.statArrayFromDailyStats(dailyStats, "revenue")}],
            impressions: [{ "Total": mopub.Stats.statArrayFromDailyStats(dailyStats, "impressions")}],
            clicks: [{ "Total": mopub.Stats.statArrayFromDailyStats(dailyStats, "clicks")}],
        };

        mopub.Chart.setupDashboardStatsChart('area');
    }

    $(function() {
        // Use breakdown to switch charts
        $('.stats-breakdown tr').click(function(e) {
            $('#dashboard-stats .stats-breakdown .active').removeClass('active');
            $(this).addClass('active');
            $('#dashboard-stats-chart').fadeOut(100, function() {
                mopub.Chart.setupDashboardStatsChart('area');
                $(this).show();
            });
        });

        mopub.graphStartDate = Date.UTC({{start_date.year}},
            {{start_date.month|add:"-1"}},
            {{start_date.day}});


        {% if daily_stats %}
          populateGraphWithStats({{daily_stats|safe}});
        {% endif %}


        // TODO: put in shared js file with dashboard. Note: latest date allowed in range is yesterday.
        // set up dateOptions
        $('#dashboard-dateOptions input').click(function() {
          var option = $(this).val();
          if(option == 'custom') {
            $('#dashboard-dateOptions-custom-modal').dialog({
              width: 570,
              buttons: [
                {
                  text: 'Set dates',
                  css: { fontWeight: '600' },
                  click: function() {
                    var from_date=$('#dashboard-dateOptions-custom-from').datepicker("getDate");
                    var to_date=$('#dashboard-dateOptions-custom-to').datepicker("getDate");
                    var num_days=Math.ceil((to_date.getTime()-from_date.getTime())/(86400000)) + 1;

                    var from_day=from_date.getDate();
                    var from_month=from_date.getMonth()+1;
                    var from_year=from_date.getFullYear();

                    $(this).dialog("close");
                    var location = document.location.href.replace(/\?.*/,'');
                    document.location.href = location+'?r='+num_days+'&s='+from_year+"-"+from_month+"-"+from_day;
                  }
                },
                {
                  text: 'Cancel',
                  click: function() {
                    $(this).dialog("close");
                  }
                }
              ]
            });
          }
          else {
            // Tell server about selected option to get new data
            var location = document.location.href.replace(/\?.*/,'');
            document.location.href = location+'?r=' + option;
          }
        });

        // set up stats breakdown dateOptions
        $('#stats-breakdown-dateOptions input').click(function() {
          $('.stats-breakdown-value').hide();
          $('.stats-breakdown-value.'+$(this).val()).show();
        });

        // set up custom dateOptions model dialog
        $('#dashboard-dateOptions-custom-from').datepicker({
          defaultDate: '-15d',
          maxDate: '-1d',
          onSelect: function(selectedDate) {
            var other = $('#dashboard-dateOptions-custom-to');
            var instance = $(this).data("datepicker");
            var date = $.datepicker.parseDate(instance.settings.dateFormat ||
                                              $.datepicker._defaults.dateFormat,
                                              selectedDate,
                                              instance.settings);
            other.datepicker('option', 'minDate', date);
          }
        });
        $('#dashboard-dateOptions-custom-to').datepicker({
          defaultDate: '-1d',
          maxDate: '-1d',
          onSelect: function(selectedDate) {
            var other = $('#dashboard-dateOptions-custom-from');
            var instance = $(this).data("datepicker");
            var date = $.datepicker.parseDate(instance.settings.dateFormat ||
                                              $.datepicker._defaults.dateFormat,
                                              selectedDate,
                                              instance.settings);
            other.datepicker('option', 'maxDate', date);
          }
        });

        $("#ad-network-exportSelect").change(function() {
            if ($(this).val() != 'exp') {
                if ('/ad_network_reports/' == $(location).attr('pathname')) {
                    if ($('.networks').css('display') == 'block') {
                        window.open($(this).val() + '/network');
                    } else {
                        window.open($(this).val() + '/app');
                    }
                } else {
                    window.open($(this).val());
                }
            }
            $(this).selectmenu('index', 0);
        });

        $('#ad-network-exportSelect-menu').find('li').first().hide();
    });
  </script>
{% endblock extraScripts %}

{% block dateButtons %}
  {% include "common/partials/datecontrols.html" %}
{% endblock dateButtons %}


{% block content %}

  {% block preContent %}
  {% endblock preContent %}

  <section id="graph">
    {% block graph %}
      {% if show_graph %}
        <section class="offset nomargin" id="dashboard-stats">
          <h3 class="stats-chart-title">Realtime Stats for {{start_date|format_date_compact}} to {{end_date|format_date_compact}}</h3>
          <div class="stats clearfix">
            <div class="stats-breakdown">
              <table class="sortable">
                <tbody>
                  <tr class="active" id="stats-breakdown-revenue">
                    <td class="stats-breakdown-value today"><span class="inner">{% if aggregates %}{{aggregates.revenue|currency}}{% else %}--{% endif %}</span></td>
                    <th class="stats-breakdown-name"><span class="inner">Revenue</span></th>
                  </tr>
                  <tr id="stats-breakdown-impressions">
                    <td class="stats-breakdown-value today"><span class="inner">{% if aggregates %}{{aggregates.impressions|withsep}}{% else %}--{% endif %}</span></td>
                    <th class="stats-breakdown-name"><span class="inner">Impressions</span></th>
                  </tr>
                  <tr id="stats-breakdown-clicks">
                    <td class="stats-breakdown-value today"><span class="inner"><span class="muted unbold">({% if aggregates %}{{aggregates.ctr|percentage}}{% else %}--{% endif %})</span> {% if aggregates %}{{aggregates.clicks|withsep}}{% else %}--{% endif %}</span></td>
                    <th class="stats-breakdown-name"><span class="inner">Clicks</span></th>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="chart stats-chart" id="dashboard-stats-chart"></div>
          </div>
        </section>
          <div style="float:right">Data shown is from the ad networks and may change. <a target="_blank" href="http://help.mopub.com/customer/portal/articles/273229-ad-network-revenue-reporting">Learn more</a></div>
      {% else %}
        <div class="alert-message block-message">
          MoPub can automatically pull ad network revenue data from most ad networks that are supported. To enable reporting for each network, enter your login credentials for the ad networks below.  MoPub will pull data each morning for the previous day.<br/>
          <br/>
          <b>Note:</b> Your credentials will be encrypted on the MoPub servers to ensure security.  These credentials will <b>only</b> be used for reading your data and displaying it to you and will not be used for any other purposes. This service is optional and only used for reporting your data.  If you choose not to use this, it will not impact the performance of your apps in MoPub.
        </div>
      {% endif %}
    {% endblock graph %}
  </section>

  {% block innerContent %}

    <section id="dashboard-apps">
      <div class="buttonBank buttonBank-right">
          <select name='exportSelect' id='ad-network-exportSelect' class='selectmenu export-selectMenu'>
              <option value="exp">Export</option>
              <option value="/ad_network_reports/export/xls/{{mapper_key}}">XLS</option>
              <option value="/ad_network_reports/export/csv/{{mapper_key}}">CSV</option>
          </select>
      </div>
      <h2>{{app_name}} on {{ad_network_name}}</h2>
      <div class="appData-details noneg" style="clear:both;">
        <table class="dataTable appData-main">
          <thead>
            <th class="dataTable-name big"></th>
            <th class="dataTable-data numeric special"> Revenue </th>
            {% if ad_network_name != MOBFOX %}
            <th class="dataTable-data numeric special"> Attempts </th>
            {% endif %}
            <th class="dataTable-data numeric special"> Impressions </th>
            <th class="dataTable-data numeric special"> CPM </th>
            {% if ad_network_name != MOBFOX %}
            <th class="dataTable-data numeric special"> Fill Rate</th>
            {% endif %}
            <th class="dataTable-data numeric special"> Clicks </th>
            <th class="dataTable-data numeric special"> CPC </th>
            <th class="dataTable-data numeric special"> CTR </th>
          </thead>
          <tbody>
              {% for stats in stats_list %}
              <tr>
                <td class="dataTable-name">{{stats.date}}</td>
                <td class="dataTable-data numeric">{{ stats.revenue|currency }}</td>
                {% if ad_network_name != MOBFOX %}
                <td class="dataTable-data numeric">{{ stats.attempts|withsep }}</td>
                {% endif %}
                <td class="dataTable-data numeric">{{ stats.impressions|withsep }}</td>
                <td class="dataTable-data numeric">{{ stats.cpm|currency }}</td>
                {% if ad_network_name != MOBFOX %}
                <td class="dataTable-data numeric">{{ stats.fill_rate|percentage }}</td>
                {% endif %}
                <td class="dataTable-data numeric">{{ stats.clicks|withsep }}</td>
                <td class="dataTable-data numeric">{{ stats.cpc|currency }}</td>
                <td class="dataTable-data numeric">{{ stats.ctr|percentage }}</td>
              </tr>
              {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  {% endblock innerContent %}

{% endblock content %}
