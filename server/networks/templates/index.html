{% extends "networks_base.html" %}
{% load filters %}

{% block pageTitle %}
<div class="breadcrumb">
    <h1>Networks</h1>
</div>
{% endblock pageTitle %}

{% block titleBarRight %}
<span class="titlebar-right">
    <a class="button" id="network-settingsButton" href="#">Edit ad network settings</a>
</span>
{% endblock titleBarRight %}

{% block preContent %}
<section id="network-settingsForm" class="hidden">
<div>
    <form accept-charset="ascii" id="networkForm" class="settingsForm">
        <fieldset id="networkForm-details" class="alt">
            <div id="settings-form-message" class="hidden alert-message block-message warning"></div>
            <div>
                <dl class="formFields" style="margin:0">
                    <dt> E-mail: </dt>
                    <dd> <input name="email" type="checkbox" {% if settings.email %} checked="true" {% endif %}/> &nbsp;Send me a daily ad network revenue report</dd>
                    <dt> Recipients: </dt>
                    <dd>
                    <textarea name="recipients" rows="3" cols="80">{{settings.recipients}}</textarea>
                    </dd>
                </dl>
            </div>
            <div class="form-submit" style="clear:both;">
                <span class="hidden" id="networkSettingsForm-loading"><img src="/images/loading2.gif"/></span>
                <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-cancel">Cancel</a></span>
                <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-submit">Save</a></span>
            </div>
        </fieldset>
    </form>
</div>
</section>
{% endblock preContent %}

{% block graph %}
{% if networks %}
<section class="offset nomargin" id="dashboard-stats">
<h3 class="stats-chart-title">
    Realtime Stats for {{start_date|format_date_compact}} to {{end_date|format_date_compact}}
</h3>
{# Controls and stats breakdown for the top realtime stats #}
<div class="stats">
    {% comment %}
    {% stats_breakdown stats %}
    {% endcomment %}
    <div class="stats">
        <div id="stats-breakdown" class="stats-breakdown">
            <table>
                <tbody>
                    <tr class="active" id="stats-breakdown-impression_count">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">Impressions</span></th>
                    </tr>
                    <tr id="stats-breakdown-click_count">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">Clicks</span></th>
                    </tr>
                    <tr id="stats-breakdown-ctr">
                        <td class="stats-breakdown-value today"><span class="inner"></span></td>
                        <td class="stats-breakdown-value yesterday"><span class="inner"></span></td>
                        <td class="stats-breakdown-value all"><span class="inner"></span></td>
                        <th class="stats-breakdown-name"><span class="inner">CTR</span></th>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="chart stats-chart" id="dashboard-stats-chart"></div>
    </div>
</div>
</section>
{% else %}
<section id="graph">
<div class="alert-message block-message">
    MoPub can can mediate the ad networks where you have an account. ...more help text
</div>
</section>
{% endif %}
{% endblock graph %}

{% block innerContent %}
{% if networks %}
<section id="dashboard-apps">
{% if reporting_networks %}
<span class="buttonset">
    <input id="show-both" type="radio" name="show-data" value="both" checked="true"/>
    <label for="show-both" title="Show network stats in green alongside MoPub stats in black.">Show Both</label>
    <input id="show-network" type="radio" name="show-data" value="network"/>
    <label for="show-network" title="Show only network stats.">Show Network Data</label>
    <input id="show-mopub" type="radio" name="show-data" value="mopub"/>
    <label for="show-mopub" title="Show only MoPub stats.">Show MoPub Data</label>
</span>
{% endif %}

{% comment %}
Make a table for ad networks that are active
{% endcomment %}
<div>
    <div class="appData-columnHeaders">
        <table class="dataTable" width=100%>
            <thead>
                <th class="networkData-icon" style="width:75px"></th>
                <th class="dataTable-name"> Name </th>
                <th class="dataTable-data numeric"> eCPM </th>
                <th class="dataTable-data numeric"> Revenue </th>
                <th class="dataTable-data numeric"> Attempts </th>
                <th class="dataTable-data numeric"> Impressions </th>
                <th class="dataTable-data numeric"> Clicks </th>
            </thead>
        </table>
    </div>
    {% for network in networks %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
        <table class="dataTable appData-main">
            <tbody>
                <tr id="{{network.name}}-row">
                    <td class="networkData-icon">
                        <a href="{% url network_details network=network.name %}">
                            <img src="/images/{{network.name}}-transparent.png" alt="{{network.pretty_name}}" width="75" height="25" />
                        </a>
                    </td>
                    <td class="dataTable-name">
                        <a href="{% url network_details network=network.name %}">
                            {{network.pretty_name}}
                        </a>
                        <div style="font-weight:normal;">Targeting: All</div>
                    </td>
                    <td class="dataTable-data numeric">
                        {% if network.reporting %}
                        <div class="cpm network-data">--</div>
                        {% endif %}
                        <div class="mopub-cpm mopub-data">--</div>
                    </td>
                    <td class="dataTable-data numeric">
                        {% if network.reporting %}
                        <div class="revenue network-data">--</div>
                        {% endif %}
                    </td>
                    {% if network.name != MOBFOX %}
                    <td class="dataTable-data numeric">
                        {% if network.reporting %}
                        <div class="attempts network-data">--</div>
                        {% endif %}
                        <div class="mopub-attempt_count mopub-data">--</div>
                    </td>
                    {% else %}
                    <td class="dataTable-data numeric"></td>
                    {% endif %}
                    <td class="dataTable-data numeric">
                        {% if network.reporting %}
                        <div class="network-data">
                            <span class="impressions">--</span> (<span class="fill-rate">--</span>)
                        </div>
                        {% endif %}
                        <div class="mopub-impressions mopub-data">
                            <span class="mopub-impression_count">--</span> (<span class="mopub-fill_rate">--</span>)
                        </div>
                    </td>
                    <td class="dataTable-data numeric">
                        {% if network.reporting %}
                        <div class="network-data">
                            <span class="clicks">--</span> (<span class="ctr">--</span>)
                        </div>
                        {% endif %}
                        <div class="mopub-clicks mopub-data">
                            <span class="mopub-click_count">--</span> (<span class="mopub-ctr">--</span>)
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>
</section>
{% endif %}

{% comment %}
Make a table for the main ad networks that are not setup
{% endcomment %}
<section>
<h2 style="padding-top:25px;">Set Up Ad Networks</h2>
{% for network in networks_to_setup %}
<div class="{% cycle 'appData' 'appData appData-alt' %}">
    <table class="dataTable appData-main">
        <tbody>
            <tr id="{{network.name}}-row">
                <td class="networkData-icon">
                    <img src="/images/{{network.name}}-transparent.png" alt="{{network.pretty_name}}" width="75" height="25" />
                </td>
                <td>
                    <a class="show-status button button-small" href="{% url edit_network network=network.name %}">Set up {{network.pretty_name}}</a>
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endfor %}
</section>

<section>
<select id='network-editSelect' class='selectmenu'>
    <option value="">Additional Networks</option>
    {% for network in additional_networks %}
    <option value="{% url edit_network network=network.name %}">{{network.pretty_name}}</option>
    {% endfor %}
</select>
</section>

{% endblock innerContent %}

{% block extraScripts %}
{{ block.super }}
<script type="text/html" id="app-on-network-row-template">
    {% include "partials/app_on_network.html" %}
</script>
<script type="text/javascript" src="/js/models/ad_network_reports.js?v=3"></script>
<script type="text/javascript" src="/js/views/ad_network_reports.js?v=3"></script>
<script type="text/javascript" src="/js/controllers/networks.js?v=0"></script>
<script type="text/javascript" src="/js/controllers/ad_network_reports.js?v=0"></script>

{% include_script "models/inventory" %}
{% include_script "views/inventory" %}
{% include_script "controllers/networks" %}
<script>
    $(function () {
        account_key = '{{ account_key }}';

        AdNetworkReportsController.initializeAdReportsIndex({
            networks_data: [{% for network in reporting_networks %} {
                network: '{{ network }}',
                models: []},
            {% endfor %}],
            only_networks: true,
            apps_data: [],
            ajax_query_string: 's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}'});

        NetworksController.initialize({
            campaign_data: {{ campaigns|safe }},
            ajax_query_string: 's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}'});
        graph_start_date = Date.UTC({{ start_date.year }}, {{ start_date.month|add:"-1" }}, {{ start_date.day }});

        today = {% if today != None %}{{ today }}{% else %}null{% endif %};

        yesterday = {% if yesterday != None %}{{ yesterday }}{% else %}null{% endif %};

        console.log({{graph_stats|safe}});
        // TODO: remove hack
        var adgroups = new AdGroups({{graph_stats|safe}});

        var graph_view = new CollectionGraphView({
            collection: adgroups,
            start_date: graph_start_date,
            today: today,
            yesterday: yesterday,
            line_graph: false,
            mopub_optimized: false,
        });
        graph_view.render();


        $('#show-both').click(function() {
            $('.mopub-data').show();
            $('.network-data').show();
        });

        $('#show-network').click(function() {
            $('.mopub-data').hide();
            $('.network-data').show();
        });

        $('#show-mopub').click(function() {
            $('.mopub-data').show();
            $('.network-data').hide();
        });


        $('.show-adunits').click(function() {
            var key = $(this).attr('id');
            var rows = $('.' + key + '-row');
            if (rows.is(':hidden')) {
                rows.show();
                $(this).html("Hide Sites");
                } else {
                rows.hide()
                $(this).html("Show Sites");
            }
        });

        $('#network-editSelect').change(function() {
            if ($(this).val()) {
                window.location = $(this).val();
            }
            $(this).selectmenu('index', 0);
        });

        $('#network-editSelect').find('li').first().hide();
    });
</script>
{% endblock extraScripts %}

