{% extends "ad_network_base.html" %}
{% load filters %}

{% block pageTitle %}
  <div class="breadcrumb">
    <h1>Networks</h1>
  </div>
{% endblock pageTitle %}

{% block titleBarRight %}
  <span class="titlebar-right">
    <a class="button" id="network-settingsButton" href="#">Edit ad network settings</a>
  </span>
{% endblock titleBarRight %}

{% block preContent %}
  <section id="network-settingsForm" class="hidden">
    <div>
      <form accept-charset="ascii" id="networkForm" class="settingsForm">
        <fieldset id="networkForm-details" class="alt">
          <div id="settings-form-message" class="hidden alert-message block-message warning"></div>
          <div>
            <dl class="formFields" style="margin:0">
              <dt> E-mail: </dt>
              <dd> <input name="email" type="checkbox" {% if settings.email %} checked="true" {% endif %}/> &nbsp;Send me a daily ad network revenue report</dd>
              <dt> Recipients: </dt>
              <dd>
                <textarea name="recipients" rows="3" cols="80">{{settings.recipients}}</textarea>
              </dd>
            </dl>
          </div>
          <div class="form-submit" style="clear:both;">
            <span class="hidden" id="networkSettingsForm-loading"><img src="/images/loading2.gif"/></span>
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-cancel">Cancel</a></span>
            <span class="buttonWrap"><a href="#" class="button" id="networkSettingsForm-submit">Save</a></span>
          </div>
        </fieldset>
      </form>
    </div>
  </section>
{% endblock preContent %}

{% block innerContent %}
  <section id="dashboard-apps">
  <span class="buttonset">
    <input id="show-both" type="radio" name="show-data" value="both" checked="true"/>
    <label for="show-both" title="Show network stats in green alongside MoPub stats in black.">Show Both</label>
    <input id="show-network" type="radio" name="show-data" value="network"/>
    <label for="show-network" title="Show only network stats.">Show Network Data</label>
    <input id="show-mopub" type="radio" name="show-data" value="mopub"/>
    <label for="show-mopub" title="Show only MoPub stats.">Show MoPub Data</label>
  </span>

  <div class="buttonBank buttonBank-right">
      <select name='exportSelect' id='ad-network-exportSelect' class='selectmenu export-selectMenu'>
          <option value="">Export</option>
          <option value="/ad_network_reports/export/xls">XLS</option>
          <option value="/ad_network_reports/export/csv">CSV</option>
      </select>
  </div>


  {% comment %}
    Make the table sorted by ad network.
  {% endcomment %}
  <h2 style="padding-top:25px;">Networks with Reporting</h2>
  <div class="tab-section networks active">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Revenue </th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate </th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for network in reporting_networks %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr id="{{network.name}}-row">
            <td class="networkData-icon">
              <img src="/images/{{network.name}}-transparent.png"
              alt="{{network.pretty_name}}" width="75" height="25" />
            </td>
            {% if network.state != LoginStates.NOT_SETUP %}
            <td class="network-status dataTable-name">

                {% if network.state == LoginStates.WORKING %}
                <span class="muted">Last synced: </span>
                {% endif %}
                <a class="show-status" style="cursor:pointer;" id="{{network.name}}-status">Status</a>
                {% if network.state == LoginStates.WORKING %}
                <div>
                    <a class="show-hide button button-small" id="{{network.name}}" style="width:75px;">Show Apps</a>
                </div>
                {% endif %}
            </td>
            {% endif %}
            {% if network.state == LoginStates.WORKING %}
              <td class="dataTable-data numeric">
                <div class="revenue network-data">--</div>
              </td>
              {% if network.name != MOBFOX %}
                <td class="dataTable-data numeric">
                  <div class="attempts network-data">--</div>
                  <div class="mopub-attempts mopub-data">{{network.mopub_stats.request_count|withsep}}</div>
                </td>
              {% else %}
                <td class="dataTable-data numeric"></td>
              {% endif %}
              <td class="dataTable-data numeric">
                <div class="impressions network-data">--</div>
                <div class="mopub-impressions mopub-data">{{network.mopub_stats.impression_count|withsep}}</div>
              </td>
              <td class="dataTable-data numeric">
                <div class="cpm network-data">--</div>
                <div class="mopub-cpm mopub-data">{{network.mopub_stats.get_cpm|currency}}</div>
              </td>
              {% if network.name != MOBFOX %}
                <td class="dataTable-data numeric">
                  <div class="fill-rate network-data">--</div>
                  <div class="mopub-fill-rate mopub-data">{{network.mopub_stats.fill_rate|percentage}}</div>
                </td>
              {% else %}
                <td class="dataTable-data numeric"></td>
              {% endif %}
              <td class="dataTable-data numeric">
                <div class="clicks network-data">--</div>
                <div class="mopub-clicks mopub-data">{{network.mopub_stats.click_count|withsep}}</div>
              </td>
              <td class="dataTable-data numeric">
                <div class="cpc network-data">--</div>
                <div class="mopub-cpc mopub-data">{{network.mopub_stats.cpc|currency}}</div>
              </td>
              <td class="dataTable-data numeric">
                <div class="ctr network-data">--</div>
                <div class="mopub-ctr mopub-data">{{network.mopub_stats.ctr|percentage}}</div>
              </td>
            {% else %}
              {% if network.state == LoginStates.NOT_SETUP %}
              <td class="network-status dataTable-name" colspan="7">
                <div class="form-{{network.name}}-enable">
                  <a class="show-status button button-small" id="{{network.name}}-status">Enable Reporting</a>
                  {% if network.mopub_app_stats %}
                    <a class="show-hide button button-small" id="{{network.name}}" style="width:75px;">Show Apps</a>
                  {% endif %}
                </div>
              </td>
              {% endif %}
            {% endif %}
          </tr>
        </tbody>
      </table>
      <div class="{{network.name}}-status hidden">
        <div class="form-{{network.name}}-message hidden alert-message block-message warning"></div>
        <dl class="formFields thin" style="margin:0">
          {% if network.state == LoginStates.ERROR %}
            <dt>Status:</dt>
            <dd>Last synchronization failed.  Check that your credentials are correct.
            If this error persists, please contact support@mopub.com.</dd>
          {% endif %}
          {% if network.apps_without_pub_ids or network.pub_ids_without_data %}
            <dt>Notes:</dt>
            <dd>
            {% if network.apps_without_pub_ids %}
              {% if network.name == IAD %}
                In order to pull revenue data for your apps, MoPub requires that your
                app names in MoPub match your app names in iAd and you assign an
                iTunes URL for each app. Click 'Edit app settings' for each app and
                enter your iTunes URL:
                <br/><br/>
                {% for app in network.apps_without_pub_ids %}<a href="/inventory/app/{{app.key}}">{{app.name}}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
            {% else %}
                In order to pull revenue data for your apps, MoPub requires that you
                assign your ad network ID for each app.  Set up your network ID on
                the <a href="/account/networks/">Ad Network Settings</a> page for the
                following apps:
                <br/><br/>
                {% for app in network.apps_without_pub_ids %}{{app.name}}{% if not forloop.last %}, {% endif %}{% endfor %}
              {% endif %}
            {% else %}
              {% if network.name == IAD %}
                MoPub received a response for the following apps. Make sure these
                apps are properly set up in MoPub to view the reports (the MoPub
                app names exactly match the iAd app names and the iTunes URLs
                are properly entered for the apps).
              {% else %}
                MoPub received a response for the following ad networks IDs.
                Make sure these apps are properly set up in MoPub to view the reports.
              {% endif %}
              <br/><br/>
              {% for id in network.pub_ids_without_data %}{{id}}{% if not forloop.last %}, {% endif %}{% endfor %}
            {% endif %}
            </dd>
          {% endif %}
        </dl>
        <form class="loginCredentials" id="form-{{network.name}}" autocomplete="off">
          <fieldset>
              <h2>{{network.pretty_name}} Credentials{% if network.name == ADMOB or network.name == INMOBI %} <a target="_blank" href="http://help.mopub.com/customer/portal/articles/{% ifequal network.name ADMOB %}274115-admob-revenue-reporting-setup{% else %}274260-inmobi-revenue-reporting-setup{% endifequal %}">(Learn more)</a> {% endif %}</h2>
              <dl class="formFields thin" style="margin:0">
                  {% if network.name == INMOBI %}
                    <dt class="wide"> Access ID: </dt>
                    <dd class="thinner">
                      <input type="text" name="{{network.name}}-username"
                      id="id_username" class="input-text input-text-half-width"
                      value=""> {{network.form.username.errors}}
                    </dd>

                    <dt class="wide"> Secret Key: </dt>
                    <dd class="thinner">
                      <input type="password" name="{{network.name}}-password"
                      id="id_password" class="input-text input-text-half-width"
                      value="">  {{network.form.password.errors}}
                    </dd>

                  {% else %}
                      {% if network.name == MOBFOX %}
                        {% if network.state == LoginStates.NOT_SETUP %}
                          Click 'update' to turn on MobFox revenue reporting.
                        {% else %}
                          MobFox revenue reporting is turned on.
                        {% endif %}
                      {% else %}
                        <dt class="wide"> Username: </dt>
                        <dd class="thinner"> <input type="text" name="{{network.name}}-username" id="id_username" class="input-text input-text-half-width" value="{{network.form.initial.username}}"> {{network.form.username.errors}}</dd>

                        <dt class="wide">{% ifequal network.name ADMOB %} API {% endifequal %}Password: </dt>
                        <dd class="thinner"> <input type="password" name="{{network.name}}-password"  id="id_password" class="input-text input-text-half-width" value="{{network.form.initial.password}}"> 
                        {{network.form.password.errors}}
                        </dd>
                      {% endif %}
                  {% endif %}


                  {% if network.name == ADMOB %}
                    <dt class="wide"> API Key: </dt>
                    <dd class="thinner"> <input type="text" name="admob-client_key"
                    id="id_admob-client_key" class="input-text
                    input-text-half-width" value="{{network.form.initial.client_key}}"></dd>
                  {% endif %}

              </dl>
          </fieldset>
        </form>
      </div>
      {% if network.state == LoginStates.WORKING or network.mopub_app_stats %}
      <div class="appData-details hidden {{network.name}}-row" style="margin: -10px 0 0 86px">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody id="app-on-{{network.name}}">
              {% for app_data in network.mopub_app_stats %}
              <tr id="{{app_data.app.identifier}}-on-{{network.name}}-row">
                <td class="dataTable-name">
                  {{app_data.app.full_name}}
                  <a id="{{app_data.app.identifier}}-on-{{network.name}}-adunit" class="show-adunits" style="cursor:pointer;">Show Sites</a>
                </td>
                <td></td>
                <td class="dataTable-data numeric">
                  <div class="attempts network-data"></div>
                  <div class="mopub-attempts mopub-data">{{app_data.stats.request_count|withsep}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="impressions network-data"></div>
                  <div class="mopub-impressions mopub-data">{{app_data.stats.impression_count|withsep}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="cpm network-data"></div>
                  <div class="mopub-cpm mopub-data">{{app_data.stats.get_cpm|currency}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="fill-rate network-data"></div>
                  <div class="mopub-fill-rate mopub-data">{{app_data.stats.fill_rate|percentage}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="clicks network-data"></div>
                  <div class="mopub-clicks mopub-data">{{app_data.stats.click_count|withsep}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="cpc network-data"></div>
                  <div class="mopub-cpc mopub-data">{{app_data.stats.cpc|currency}}</div>
                </td>
                <td class="dataTable-data numeric">
                  <div class="ctr network-data"></div>
                  <div class="mopub-ctr mopub-data">{{app_data.stats.ctr|percentage}}</div>
                </td>
              </tr>
              {% for adunit in app_data.adunits %}
              <tr class="{{app_data.app.identifier}}-on-{{network.name}}-adunit-row hidden">
                <td class="dataTable-name">{{adunit.name}}</td>
                <td></td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.request_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.impression_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.get_cpm|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.fill_rate|percentage}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.click_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.cpc|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.ctr|percentage}}
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  </section>

  <section>
  <h2 style="padding-top:25px;">Other Networks</h2>
  <div class="tab-section networks active">
    <div class="appData-columnHeaders">
      <table class="dataTable" width=100%>
        <thead>
          <th class="networkData-icon" style="width:75px"></th>
          <th class="dataTable-name"></th>
          <th class="dataTable-data numeric"> Attempts </th>
          <th class="dataTable-data numeric"> Impressions </th>
          <th class="dataTable-data numeric"> CPM </th>
          <th class="dataTable-data numeric"> Fill Rate </th>
          <th class="dataTable-data numeric"> Clicks </th>
          <th class="dataTable-data numeric"> CPC </th>
          <th class="dataTable-data numeric"> CTR </th>
        </thead>
      </table>
    </div>
    {% for network in other_networks %}
    <div class="{% cycle 'appData' 'appData appData-alt' %}">
      <table class="dataTable appData-main">
        <tbody>
          <tr id="{{network.name}}-row">
            <td class="networkData-icon">
              <img src="/images/{{network.name}}-transparent.png" alt="{{network.pretty_name}}" width="75" height="25" />
            </td>
            <td class="network-status dataTable-name">
              <a class="show-hide button button-small" id="{{network.name}}" style="width:75px;">Show Apps</a>
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.request_count|withsep}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.impression_count|withsep}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.get_cpm|currency}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.fill_rate|percentage}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.click_count|withsep}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.cpc|currency}}
            </td>
            <td class="dataTable-data numeric">
              {{network.mopub_stats.ctr|percentage}}
            </td>
          </tr>
        </tbody>
      </table>
      <div class="appData-details hidden {{network.name}}-row" style="margin: -10px 0 0 86px">
        <div class="appData-details-inner show">
          <table class="dataTable">
            <tbody id="app-on-{{network.name}}">
              {% for app_data in network.mopub_app_stats %}
              <tr id="{{app_data.app.identifier}}-on-{{network.name}}-row">
                <td class="dataTable-name">
                  {{app_data.app.full_name}}
                  <a id="{{app_data.app.identifier}}-on-{{network.name}}-adunit" class="show-adunits" style="cursor:pointer;">Show Sites</a>
                </td>
                <td></td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.request_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.impression_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.get_cpm|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.fill_rate|percentage}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.click_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.cpc|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{app_data.stats.ctr|percentage}}
                </td>
              </tr>
              {% for adunit in app_data.adunits %}
              <tr class="{{app_data.app.identifier}}-on-{{network.name}}-adunit-row hidden">
                <td class="dataTable-name">{{adunit.name}}</td>
                <td></td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.request_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.impression_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.get_cpm|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.fill_rate|percentage}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.click_count|withsep}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.cpc|currency}}
                </td>
                <td class="dataTable-data numeric">
                  {{adunit.stats.ctr|percentage}}
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  </section>

  <a id="add_campaign_button" class="right button add icon"  href="{% url add_network %}">Add a network</a>
{% endblock innerContent %}

{% block extraScripts %}
  {{ block.super }}
  <script type="text/html" id="app-on-network-row-template">
    {% include "partials/app_on_network.html" %}
  </script>
  <script type="text/javascript" src="/js/models/ad_network_reports.js?v=3"></script>
  <script type="text/javascript" src="/js/views/ad_network_reports.js?v=3"></script>
  <script type="text/javascript" src="/js/controllers/networks.js?v=0"></script>
  <script type="text/javascript" src="/js/controllers/ad_network_reports.js?v=0"></script>
  <script>
    $(function () {
        account_key = '{{ account_key }}';
        AdNetworkReportsController.initializeCredentialsPage(account_key);

        AdNetworkReportsController.initializeAdReportsIndex({
        networks_data: [{% for network in reporting_networks %} {
           network: '{{ network.name }}',
           models: [{% for app_data in network.mopub_app_stats %}
            {% if app_data.pub_id %}{
              id: '{{ app_data.pub_id }}',
              app_identifier: '{{ app_data.app.identifier }}',
              network: '{{ network.name }}'},
            {% endif %}
          {% endfor %}]},
        {% endfor %}],
        apps_data: [],
        ajax_query_string: 's={{ start_date.year }}-{{ start_date.month }}-{{ start_date.day }}&r={{ date_range }}'});

        $('#show-both').click(function() {
            $('.mopub-data').show();
            $('.network-data').show();
        });

        $('#show-network').click(function() {
            $('.mopub-data').hide();
            $('.network-data').show();
        });

        $('#show-mopub').click(function() {
            $('.mopub-data').show();
            $('.network-data').hide();
        });


        $('.show-adunits').click(function() {
            var key = $(this).attr('id');
            var rows = $('.' + key + '-row');
            if (rows.is(':hidden')) {
              rows.show();
              $(this).html("Hide Sites");
            } else {
              rows.hide()
              $(this).html("Show Sites");
            }
        });
    });
  </script>
{% endblock extraScripts %}
