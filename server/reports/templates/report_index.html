{% extends 'reports/base.html' %}
{% load filters %}
{% block pageTitle %}<h1>Reports</h1>{% endblock pageTitle %}
{% block dateButtons %}{% endblock dateButtons %}
{% block content %}
<div class="buttonBank buttonBank-right">
    <a class="button" id="reports-addReportButton" href="#">New Report</a>
</div>
<h2>Saved Reports</h2>
<section id="reports-reportAddForm" class='hidden'>
    <div>
        <form action="{% url add_report %}" method="POST" accept-charset="utf-8" id="reportCreateForm">
            <input type='hidden' name='saved' value='False' />
            <fieldset id="reportAddForm-details" class="alt">
                <div id="reportAddForm-fragment" class="reportAddForm-fragment">
                    {{report_fragment.as_template}}
                </div>
                <div class='clear'></div>
                <div class='form-submit'>
                    <span id='reportCreateForm-success' class='hidden'>Success!</span>
                    <span class='buttonWrap'><a href='#' class='button' id='reportCreateForm-run'>Run Report</a></span>
                    <span class='buttonWrap'><a href='#' class='button' id='reportCreateForm-save'>Run and Save</a></span>
                    <span class='buttonWrap'><a href='#' class='button' id='reportCreateForm-cancel'>Cancel</a></span>
                </div>
            </fieldset>
        </form>
    </div>
</section>
<section id='report-savedReports'>
<form id='reportStateChangeForm' action={% url report_state_change %} method='post'>
    <input type=hidden id='action' name='action' />
    <table class='reportData-table reportData-saved dataTable reportTable' id='reports-saved-columnHeaders'>
        <thead>
            <tr>
                <th class='reportData-icon'></th>
                <th class='dataTable-name'>Name</th>
                <th class='dataTable-name'>Details</th>
                <th class='dataTable-date'>Last Run</th>
                <th class='dataTable-data'>Scheduled</th>
                <th class='dataTable-data'>Status</th>
                <th class='dataTable-data numeric'></th>
            </tr>
        </thead>
        <tbody>
            {% for report in scheduled %}
            <tr class="{% cycle 'reportData' 'reportData reportData-alt' %}" id='{{ report.key }}-row'>
                <td class='reportData-icon'>
                    <input type='checkbox' name='reportChangeStateForm-key' value='{{report.key}}'/>
                </td>
                {% comment %}
                do stuff for editing report on the fly
                {% endcomment %}
                <th class='dataTable-name'>
                    <div class="report-name">
                        {{ report.name }}
                    </div>
                    <div id="{{ report.key }}-edit-link" class="edit-link hidden">
                        <span class="ui-icon ui-icon-wrench"></span>
                    </div>

                    <div id='{{ report.key }}-reportForm-container' style='display: none;'>
                      <form action="{% url add_report %}" method="POST" accept-charset="utf-8" id="reportCreateForm">
                        <fieldset id="reportAddForm-details" class="alt">
                          <div id="reportAddForm-fragment" class="reportAddForm-fragment">
                            {{report.form.as_template}}
                          </div>
                          <input name='report_key' type='hidden' value='{{report.key}}' />
                          <input id='{{ report.key }}-saveAs' name='saved' type='hidden' value='False' />
                          <div class='clear'></div>
                          <div class='form-submit'>
                            <span id='reportCreateForm-success' class='hidden'>Success!</span>
                            <span class='buttonWrap'><a href='#' class='button' id='{{ report.key }}-reportCreateForm-save'>Save</a></span>
                            <span class='buttonWrap'><a href='#' class='button' id='{{ report.key }}-reportCreateForm-cancel'>Cancel</a></span>
                          </div>
                        </fieldset>
                      </form>
                    </div>

                </th>
                <td class='dataTable-name'>{{report.details|safe}}</td>
                <td id='{{report.key}}-status' class='dataTable-date'>
                  {% if report.status == 'Completed' %}
                    {{report.last_run|date:'N j, Y \<\b\r /\> f a'|safe}}
                  {% endif %}
                </td>
                <td class='dataTable-data'>{% if report.sched_interval == 'none' or not report.sched_interval %}{% else %}{{report.sched_interval|capfirst}}{% endif %}</td>
                <td class='dataTable-name'>
                    {% if report.status == 'Completed' %}
                    <a href='{% url report_export report_key=report.key %}'>Export</a>
                    {% else %}
                      {{report.status}}
                    {% endif %}
                </td>
                <td class='dataTable-data numeric'></td>
            </tr>
            {% endfor %}
            <tr class="reportData reportData-placeholder">
                <th class="reportData-icon"></th>
                <th class="dataTable-name"><span class="muted">None</span></th>
                <td class="dataTable-data numeric"></td>
                <td class="dataTable-data numeric"></td>
                <td class="dataTable-date"></td>
                <td class="dataTable-data numeric"></td>
            </tr>
        </tbody>
    </table>
    <div class='form-submit-left'>
        <a class='button' id='reportStateChangeForm-delete'>Delete</a>
    </div>
</form>
</section>
{% endblock content %}

{% block extraScripts %}
{{ block.super }}
<script>
    $(function () {
        ReportIndexController.initialize({
            report_keys: [{% for report in scheduled %}'{{ report.key }}',{% endfor %}],
        });
    });
</script>
{% endblock extraScripts %}
